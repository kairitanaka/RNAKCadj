---
title: "adjustment_VGP_benchmark"
output: html_document
---

Set up
```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = here::here())

knitr::opts_chunk$set(echo = FALSE,
                      eval = FALSE,
                      message = FALSE,
                      warning = FALSE)

require(tidyverse)
library(variancePartition)
require(GSVA)
require(msigdbr)


```

```{r, eval=TRUE, fig.width=8, fig.height=5}

library(tidyverse)

# load your signatures
load("exploring_melanoma_signatures/results/melanoma_signatures_list.rda")  # gives gene_list

# make tidy table of only VGP signatures
vgp_sizes <- tibble(
  signature = names(gene_list),
  n_upgenes = lengths(gene_list)
) %>%
  filter(str_detect(signature, "^vgp_")) %>%           # keep only VGP
  arrange(n_upgenes) %>%
  mutate(signature = factor(signature, levels = signature))  # order for plotting

# plot with counts
ggplot(vgp_sizes, aes(x = signature, y = n_upgenes)) +
  geom_col(fill = "blue") +
  geom_text(aes(label = n_upgenes), 
            hjust = -0.2, 
            size = 3.5) +
  coord_flip() +
  labs(x = "VGP signature", y = "Up-regulated genes (count)",
       title = "Up genes per VGP signature") +
  theme_classic(base_size = 12) +
  expand_limits(y = max(vgp_sizes$n_upgenes) * 1.1)  # add space for labels


```
```{r, eval=TRUE, fig.width=8, fig.height=5}

library(tidyverse)

# load your signatures
load("exploring_melanoma_signatures/results/melanoma_signatures_list.rda")  # gives gene_list

# make tidy table of only VGP signatures
vgp_sizes <- tibble(
  signature = names(gene_list),
  n_upgenes = lengths(gene_list)
) %>%
  filter(str_detect(signature, "^rgp_")) %>%           # keep only VGP
  arrange(n_upgenes) %>%
  mutate(signature = factor(signature, levels = signature))  # order for plotting

# plot with counts
ggplot(vgp_sizes, aes(x = signature, y = n_upgenes)) +
  geom_col(fill = "red") +
  geom_text(aes(label = n_upgenes), 
            hjust = -0.2, 
            size = 3.5) +
  coord_flip() +
  labs(x = "RGP signature", y = "Up-regulated genes (count)",
       title = "Up genes per RGP signature") +
  theme_classic(base_size = 12) +
  expand_limits(y = max(vgp_sizes$n_upgenes) * 1.1)  # add space for labels

```




```{r, eval=TRUE}

library(tidyverse)

# pull out the baseline "no adjustment" VGP signature
baseline <- gene_list[["vgp_no_adj"]]

# collect all VGP signatures
vgp_sigs <- gene_list[grep("^vgp_", names(gene_list))]

# build a table comparing each adjustment to baseline
compare_to_baseline <- map_df(names(vgp_sigs), function(sig) {
  current <- vgp_sigs[[sig]]
  
  tibble(
    signature = sig,
    total_genes = length(current),
    overlap_with_baseline = length(intersect(baseline, current)),
    unique_to_baseline = length(setdiff(baseline, current)),
    unique_to_sig = length(setdiff(current, baseline))
  )
})

compare_to_baseline

```

```{r, eval=TRUE, fig.width=8, fig.height=5}

library(tidyverse)
library(msigdbr)

# Load required libraries and data
library(tidyverse)
library(msigdbr)

# Load gene signatures
load("exploring_melanoma_signatures/results/melanoma_signatures_list.rda")

# Helper function
ids_to_symbols <- function(gene_ids) {
  annotations_db %>%
    filter(GeneID %in% gene_ids, !is.na(Symbol), nzchar(Symbol)) %>%
    distinct(Symbol) %>%
    pull(Symbol)
}

# Get Hallmark genes
hallmark_genes <- msigdbr(species = "Homo sapiens", category = "H") %>%
  pull(gene_symbol) %>%
  unique()

# Create vgp_list
vgp_list <- gene_list[grepl("^vgp_", names(gene_list))]

# Then your existing analysis code...

# ---- 1) Load signatures + annotations (gives: gene_list, annotations_db) ----
load("exploring_melanoma_signatures/results/melanoma_signatures_list.rda")

# helper: map a vector of Entrez GeneIDs -> unique Symbols via annotations_db
ids_to_symbols <- function(gene_ids) {
  annotations_db %>%
    dplyr::filter(GeneID %in% gene_ids, !is.na(Symbol), nzchar(Symbol)) %>%
    dplyr::distinct(Symbol) %>%
    dplyr::pull(Symbol)
}

# ---- 2) Choose baseline (no adjustment) for VGP ----
baseline_vgp_ids <- gene_list[["vgp_no_adj"]]
baseline_vgp_sym <- ids_to_symbols(baseline_vgp_ids)

# All VGP signatures to compare (as IDs)
vgp_ids <- gene_list[grep("^vgp_", names(gene_list))]
vgp_names <- names(vgp_ids)

# Also prepare symbol-mapped versions (for Hallmark comparison)
vgp_sym <- setNames(lapply(vgp_ids, ids_to_symbols), vgp_names)

# ---- 3) Hallmark genes (Symbols) ----
H <- msigdbr(species = "Homo sapiens", category = "H") %>%
  dplyr::select(gs_name, gene_symbol)
hallmark_union_sym <- unique(H$gene_symbol)

# (optional) restrict to tumor-biology hallmarks:
# hallmarks_focus <- c("HALLMARK_E2F_TARGETS","HALLMARK_G2M_CHECKPOINT","HALLMARK_MYC_TARGETS_V1",
#                      "HALLMARK_MYC_TARGETS_V2","HALLMARK_DNA_REPAIR","HALLMARK_APOPTOSIS",
#                      "HALLMARK_P53_PATHWAY","HALLMARK_PI3K_AKT_MTOR_SIGNALING",
#                      "HALLMARK_MTORC1_SIGNALING","HALLMARK_KRAS_SIGNALING_UP",
#                      "HALLMARK_TNFA_SIGNALING_VIA_NFKB","HALLMARK_TGF_BETA_SIGNALING",
#                      "HALLMARK_WNT_BETA_CATENIN_SIGNALING","HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION",
#                      "HALLMARK_ANGIOGENESIS","HALLMARK_HYPOXIA","HALLMARK_UV_RESPONSE_UP",
#                      "HALLMARK_UV_RESPONSE_DN","HALLMARK_INTERFERON_ALPHA_RESPONSE",
#                      "HALLMARK_INTERFERON_GAMMA_RESPONSE")
# hallmark_union_sym <- H %>% filter(gs_name %in% hallmarks_focus) %>% pull(gene_symbol) %>% unique()

# ---- 4) Compare each VGP signature to baseline & count lost Hallmark genes ----
compare_tbl <- purrr::map_dfr(vgp_names, function(sig) {
  cur_ids <- vgp_ids[[sig]]
  cur_sym <- vgp_sym[[sig]]

  # genes (IDs) lost vs baseline (IDs)
  lost_ids <- setdiff(baseline_vgp_ids, cur_ids)

  # convert just the lost IDs -> Symbols, then intersect with Hallmark Symbols
  lost_sym <- ids_to_symbols(lost_ids)
  lost_hallmark_sym <- intersect(lost_sym, hallmark_union_sym)

  tibble(
    signature             = sig,
    total_genes           = length(cur_ids),
    overlap_with_baseline = length(intersect(baseline_vgp_ids, cur_ids)),
    unique_to_baseline    = length(lost_ids),
    lost_hallmark_count   = length(lost_hallmark_sym)
  )
}) %>%
  arrange(desc(lost_hallmark_count), signature)

compare_tbl

# (Optional) which Hallmark genes were lost for each signature?
lost_details <- purrr::map_dfr(vgp_names, function(sig) {
  lost_ids <- setdiff(baseline_vgp_ids, vgp_ids[[sig]])
  lost_sym <- ids_to_symbols(lost_ids)
  tibble(signature = sig,
         lost_hallmark_gene = sort(intersect(lost_sym, hallmark_union_sym)))
})
# View(lost_details) or write.csv(lost_details, "lost_hallmark_genes_per_signature.csv", row.names = FALSE)

# ---- 5) Minimal bar plot (#Up genes per VGP signature) w/ baseline dashed line + labels ----
vgp_sizes <- tibble(
  signature = vgp_names,
  n_upgenes = lengths(vgp_ids)
) %>%
  arrange(n_upgenes) %>%
  mutate(signature = factor(signature, levels = signature))

ggplot(vgp_sizes, aes(signature, n_upgenes)) +
  geom_col() +
  geom_text(aes(label = n_upgenes), hjust = -0.15, size = 3.5) +
  geom_hline(yintercept = length(baseline_vgp_ids), linetype = "dashed", linewidth = 0.4) +
  coord_flip() +
  labs(x = "VGP signature", y = "Up-regulated genes (count)",
       title = "VGP Up counts vs baseline (dashed)") +
  theme_classic(base_size = 12) +
  expand_limits(y = max(vgp_sizes$n_upgenes) * 1.1)

```





```{r, eval=TRUE, fig.width=8, fig.height=5}

# Count Hallmark genes present in each VGP signature
hallmark_present_tbl <- purrr::map_dfr(names(vgp_list), function(sig) {
  sig_sym <- ids_to_symbols(vgp_list[[sig]])
  present_hallmark <- intersect(sig_sym, hallmark_genes)
  
  tibble(
    signature = sig,
    total_genes = length(sig_sym),
    hallmark_present = length(present_hallmark),
    hallmark_percent = round(100 * length(present_hallmark) / length(sig_sym), 1)
  )
}) %>%
  arrange(desc(hallmark_present))

# View the table
print(hallmark_present_tbl)

# Plot it
# Clean plot with better formatting
ggplot(hallmark_present_tbl, aes(x = factor(signature, levels = signature),
                                 y = hallmark_present)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = hallmark_present), 
            hjust = -0.1, size = 3, color = "black") +
  coord_flip() +
  labs(x = "VGP signature",
       y = "Number of Hallmark genes present",
       title = "Hallmark genes retained in each VGP signature") +
  theme_classic(base_size = 10) +
  theme(
    plot.title = element_text(size = 12, margin = margin(b = 20)),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(10, 40, 10, 10)  # top, right, bottom, left
  ) +
  expand_limits(y = max(hallmark_present_tbl$hallmark_present) * 1.15)

```


```{r, eval=TRUE, fig.width=8, fig.height=5}

# Get baseline Hallmark genes
baseline_vgp_sym <- ids_to_symbols(gene_list[["vgp_no_adj"]])
baseline_hallmarks <- intersect(baseline_vgp_sym, hallmark_genes)

# For each signature, find lost Hallmark genes
hallmark_losses <- purrr::map_dfr(names(vgp_list), function(sig) {
  if(sig == "vgp_no_adj") return(tibble(signature = sig, lost_hallmark = character(0)))
  
  sig_sym <- ids_to_symbols(vgp_list[[sig]])
  sig_hallmarks <- intersect(sig_sym, hallmark_genes)
  lost_hallmarks <- setdiff(baseline_hallmarks, sig_hallmarks)
  
  tibble(
    signature = sig,
    lost_hallmark = lost_hallmarks
  )
})

# Create summary table
loss_summary <- hallmark_losses %>%
  group_by(signature) %>%
  summarise(
    lost_count = n(),
    lost_genes = paste(lost_hallmark, collapse = ", "),
    .groups = "drop"
  ) %>%
  arrange(desc(lost_count))

print(loss_summary)

# Plot the counts
ggplot(loss_summary, aes(x = reorder(signature, lost_count), y = lost_count)) +
  geom_col(fill = "red", alpha = 0.7) +
  geom_text(aes(label = lost_count), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(x = "VGP signature",
       y = "Number of Hallmark genes lost vs baseline",
       title = "Hallmark genes lost in each VGP signature vs vgp_no_adj") +
  theme_classic(base_size = 10) +
  expand_limits(y = max(loss_summary$lost_count) * 1.1)

# Detailed table showing which specific genes are lost per signature
knitr::kable(loss_summary, 
             caption = "Hallmark genes lost per VGP signature compared to baseline")


```


```{r}
# Define your function (already done)
rgp_to_vgp_similarity <- function(rgp_sig, vgp_baseline) {
  overlap <- length(intersect(rgp_sig, vgp_baseline))
  union_size <- length(union(rgp_sig, vgp_baseline))
  jaccard_similarity <- overlap / union_size
  return(jaccard_similarity)
}

# Get all RGP signature names
rgp_names <- names(gene_list)[grepl("^rgp_", names(gene_list))]
vgp_reference <- gene_list[["vgp_no_adj"]]

# Calculate similarity for each RGP signature
similarity_results <- tibble(
  signature = rgp_names,
  similarity_to_vgp = map_dbl(rgp_names, function(sig) {
    rgp_to_vgp_similarity(gene_list[[sig]], vgp_reference)
  })
) %>%
  arrange(desc(similarity_to_vgp))

print(similarity_results)

# Plot the results
ggplot(similarity_results, aes(x = reorder(signature, similarity_to_vgp), 
                               y = similarity_to_vgp)) +
  geom_col(fill = "red", alpha = 0.7) +
  geom_text(aes(label = round(similarity_to_vgp, 3)), 
            hjust = -0.1, size = 3) +
  coord_flip() +
  labs(x = "RGP signature", 
       y = "Jaccard similarity to VGP baseline",
       title = "RGP signatures similarity to VGP (over-adjustment check)") +
  theme_classic() +
  expand_limits(y = max(similarity_results$similarity_to_vgp) * 1.1)

```