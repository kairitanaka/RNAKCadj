---
title: "exploring_melanoma_signatures"
author: "Lewis E Tomalin, PhD"
date: "2025-08-21"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = here::here())

knitr::opts_chunk$set(echo = FALSE,
                      eval = FALSE,
                      message = FALSE,
                      warning = FALSE)

require(tidyverse)
library(variancePartition)
require(GSVA)
require(msigdbr)


```

## Let's set the scene

We have *three* RGP signatures.

* **rgp_no_adj:** created in 'tissue_type_degs'
* **rgp_canonical_kc_adj:** created in 'tissue_type_degs_canonical_kc_adjust'
* rgp_xcell_kc_adj: created in 'tissue_type_degs_xcell_kc_adjust'

We have *three* VGP signatures.

* vgp_no_adj: created in 'tissue_type_degs'
* vgp_canonical_kc_adj: created in 'tissue_type_degs_canonical_kc_adjust'
* vgp_xcell_kc_adj: created in 'tissue_type_degs_xcell_kc_adjust'

```{r preknit1}

# creates gene sets for the rgp and vgp signatures mentioned above 

file_list <- c(no_adj='tissue_type_degs/results/vobj_fit_contrasts.rda',
               canonical_kc_adj='tissue_type_degs_cononical_kc_adjust/results/vobj_fit_contrasts.rda',
               xcell_kc_adj='tissue_type_degs_xcell_kc_adjust/results/vobj_fit_contrasts.rda')

L = 'no_adj'

rm(gene_list_pt1)

lapply(names(file_list), function(L){
  
  print(L)
  
  load(file_list[[L]])
  
  db_contrasts %>%
    filter(contrast %in% c('VGP_vs_Nevus'),
           SIG == 'Up') %>% .$GeneID %>% unique() -> vgp_sig
  
  db_contrasts %>%
    filter(contrast %in% c('RGP_vs_Nevus'),
           SIG == 'Up') %>% .$GeneID %>% unique() -> rgp_sig
  
  sig_list <- list(vgp=vgp_sig,
                   rgp=rgp_sig)
  
  names(sig_list) <- paste(names(sig_list), L, sep='_')
  
    print(names(sig_list))
  
  return(sig_list)
  
}) -> gene_list_pt1
  
do.call('c', gene_list_pt1) -> gene_list_pt1

names(gene_list_pt1)

```


We also have *three* signatures for genes associated with keratinocytes

* xcell_kc_assoc: created in 'genes_associated_with_xcell_kc'
* canonical_kc_gsva_assoc: created in 'genes_associated_with_canonical_kc_gsva'
* canonical_kc_ssgsea_assoc: created in 'genes_associated_with_canonical_kc_ssgsea'

From these signatures we can create 9 more signatures by removing the keratinocyte signature genes from the RGP signatures. 

* rgp_no_adj_xcell_kc_assoc:
* rgp_no_adj_canonical_kc_gsva_assoc:
* rgp_no_adj_ssgsea_assoc:

* rgp_canonical_kc_adj_xcell_kc_assoc:
* rgp_canonical_kc_adj_canonical_kc_gsva_assoc:
* rgp_canonical_kc_adj_ssgsea_assoc:

* rgp_xcell_kc_adj_xcell_kc_assoc:
* rgp_xcell_kc_adj_canonical_kc_gsva_assoc:
* rgp_xcell_kc_adj_ssgsea_assoc:

and the VGP signatures

* vgp_no_adj_xcell_kc_assoc:
* vgp_no_adj_canonical_kc_gsva_assoc:
* vgp_no_adj_ssgsea_assoc:

* vgp_canonical_kc_adj_xcell_kc_assoc:
* vgp_canonical_kc_adj_canonical_kc_gsva_assoc:
* vgp_canonical_kc_adj_ssgsea_assoc:

* vgp_xcell_kc_adj_xcell_kc_assoc:
* vgp_xcell_kc_adj_canonical_kc_gsva_assoc:
* vgp_xcell_kc_adj_ssgsea_assoc:

```{r preknit2}

## creates gene set list for the three keratinocyte-associated sets.
## and removes them from the vgp and rgp signatures

load('data/processed/DGE_final_samples.rda')

file_list <- c(canonical_kc_ssgsea_assoc='genes_associated_with_canonical_kc_ssgsea/results/vobj_fit_contrasts.rda',
               canonical_kc_gsva_assoc='genes_associated_with_canonical_kc_gsva/results/vobj_fit_contrasts.rda',
               xcell_kc_assoc='genes_associated_with_xcell_kc/results/vobj_fit_contrasts.rda')


L = 'canonical_kc_gsva_assoc'

lapply(names(file_list), function(L){
  
  print(L)
  
  load(file_list[[L]])
  
  db_contrasts %>%
    filter(logFC > 1, 
           adj.P.Val < 0.05) %>% .$Symbol -> kc_geneid
  
  dge_final$genes %>%
    filter(Symbol %in% kc_geneid,
           complete.cases(GeneID)) %>%
    .$GeneID -> kc_geneid
  
  lapply(gene_list_pt1, function(L){
    
    vec <- setdiff(L, kc_geneid)
    
    return(vec)
    
  }) -> gene_list_temp
  
  names(gene_list_temp) <- paste0(names(gene_list_temp), '_', L)
  
  return(gene_list_temp)
  
}) -> gene_list_pt2

do.call('c', gene_list_pt2) -> gene_list_pt2

str(gene_list_pt2)



```

Additionally, we have a list of genes that contain *KRT* in their name.

We make a further set of RGP and VGP signatures with these KRT genes removed.

* rgp_no_adj_no_krt_genes:
* rgp_canonical_kc_adj_no_krt_genes:
* rgp_xcell_kc_adj_no_krt_genes:

* vgp_no_adj_no_krt_genes:
* vgp_canonical_kc_adj_no_krt_genes:
* vgp_xcell_kc_adj_no_krt_genes:


```{r preknit3}

load('data/processed/DGE_final_samples.rda')

dge_final$genes %>%
  filter(str_detect(Symbol, 'KRT'))

dge_final$genes %>%
  filter(str_detect(Symbol, 'KRT')) %>%
  .$GeneID -> krt_geneid

lapply(gene_list_pt1, function(L){
  
  vec <- setdiff(L, krt_geneid)
  
  return(vec)
  
}) -> gene_list_pt3

names(gene_list_pt3) <- paste0(names(gene_list_pt3), '_no_krt_genes')

gene_list <- c(gene_list_pt1,
               gene_list_pt2,
               gene_list_pt3)


dge_final$genes -> annotations_db

## remove duplicate gene_id from the list

lapply(gene_list, 
       function(L){
         
         temp = unique(L)
         
         return(temp)
         
       }) -> gene_list

sort(names(gene_list))
table(duplicated(names(gene_list)))

save(gene_list, annotations_db,
     file='exploring_melanoma_signatures/results/melanoma_signatures_list.rda')

```


```{r preknit4}

## This chunk calculates enrichment scores for the melanoma signatures

load('data/processed/DGE_final_samples.rda')

load(file='exploring_melanoma_signatures/results/melanoma_signatures_list.rda')

dge_final <- calcNormFactors(dge_final)

log_cpm <- cpm(dge_final, log = TRUE, prior.count = 1)

ssgsea_params <- GSVA::ssgseaParam(exprData = log_cpm,
                                   geneSets = gene_list, 
                                   minSize = 1)

ssgsea_score_results <-  gsva(param = ssgsea_params)

gsva_params <- GSVA::gsvaParam(exprData= log_cpm,
                               geneSets= gene_list, 
                               minSize = 1)

gsva_score_results <- gsva(param = gsva_params)

  
rownames(ssgsea_score_results) <- paste0('ssgsea_', rownames(ssgsea_score_results))
rownames(gsva_score_results) <- paste0('gsva_', rownames(gsva_score_results))

melanoma_enrichment_scores <- cbind(ssgsea_score_results %>% 
                                            as.data.frame() %>% t(), 
                                          gsva_score_results %>% 
                                            as.data.frame() %>% t())

melanoma_enrichment_scores <- as.data.frame(melanoma_enrichment_scores)

melanoma_enrichment_scores$samples <- rownames(melanoma_enrichment_scores)

load(file='data/processed/db_gsva_custom_correct.rda')
load(file='data/processed/db_ssgsea_custom_correct.rda')

db_gsva_custom_correct %>%
  full_join(db_ssgsea_custom_correct) %>%
  full_join(melanoma_enrichment_scores) -> melanoma_enrichment_scores

rownames(melanoma_enrichment_scores) <- melanoma_enrichment_scores$samples

# add the xcell signatures

read_delim('data/xcell_output/xCell_exprs_for_xcell_xCell_1448071725.txt') %>%
  rename(cell_id=...1) %>% 
  column_to_rownames('cell_id') %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column('sample_id') %>%
  janitor::clean_names() %>%
  column_to_rownames('sample_id') -> cell_data

colnames(cell_data) <- paste0('xcell_', colnames(cell_data))

cbind(melanoma_enrichment_scores, cell_data[rownames(melanoma_enrichment_scores),]) -> melanoma_enrichment_scores

save(melanoma_enrichment_scores, gene_list,
     file='exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')


```


## Screening RGP melanoma signatures for association with xCell KC score

Here we screen our signatures for association with xCell KC scores.

1. We do this using linear mixed-effects models, focusing on rgp first

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_canonical_kc_adj'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_rgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  # we are doing arcsin() transformation on the xcell_keratinocytes score, so it is no longer 0-1 bound 
  
  melanoma_enrichment_scores$asin_xcell_keratinocytes <- asin(sqrt(melanoma_enrichment_scores$xcell_keratinocytes))
  
  lmer(var ~ asin_xcell_keratinocytes + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
       data=melanoma_enrichment_scores) -> mod3
  
  mod3 %>%
    emtrends(specs = ~1, var='asin_xcell_keratinocytes') %>% as.data.frame() -> mean_ci
  
  mod3 %>%
    emtrends(specs = ~1, var='asin_xcell_keratinocytes') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  return(results_temp)
  
  
}) %>% bind_rows() -> results_all


require(rstatix)

results_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(asin_xcell_keratinocytes.trend)) -> results_all

results_all$gene_set <- factor(results_all$gene_set,
                               levels=results_all$gene_set)
  
results_all %>%
  filter(str_detect(gene_set, 'vgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=asin_xcell_keratinocytes.trend, 
             y=reorder(gene_set, asin_xcell_keratinocytes.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with xCell KC score',
       y='gene set', title='rgp signatures by xCell KC, LME')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```
Let's take a closer look at the model to get some interpretation.

```{r echo=T}

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_canonical_kc_adj'

melanoma_enrichment_scores$asin_xcell_keratinocytes <- asin(sqrt(melanoma_enrichment_scores$xcell_keratinocytes))

lmer(gsva_rgp_xcell_kc_adj_xcell_kc_assoc ~ asin_xcell_keratinocytes + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
     data=melanoma_enrichment_scores) -> mod3

summary(mod3)


```

2. We can also check this using pearson correlation.

This will be less precise as it won't account for covariates.

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)
require(rstatix)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_canonical_kc_adj'

# we are doing arcsin() transformation on the xcell_keratinocytes score, so it is no longer 0-1 bound 

melanoma_enrichment_scores$asin_xcell_keratinocytes <- asin(sqrt(melanoma_enrichment_scores$xcell_keratinocytes))

melanoma_enrichment_scores %>%
  select(asin_xcell_keratinocytes, starts_with('gsva_rgp')) %>%
  cor_test(vars = 'asin_xcell_keratinocytes',
           method = "pearson") -> corr_results_rgp


corr_results_rgp %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(cor)) -> corr_results_rgp

corr_results_rgp$gene_set <- factor(corr_results_rgp$var2,
                               levels=corr_results_rgp$var2)
  
corr_results_rgp %>%
  filter(str_detect(gene_set, 'vgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=cor, 
             y=reorder(gene_set, cor),
             color=p.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  xlim(-1, 1)+
  geom_point()+
  theme_classic()+
  labs(x='pearson cor with xCell KC score',
       y='gene set', title='rgp signatures by xCell KC correlation')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

The signature with the least association with xcell KC score was *gsva_rgp_xcell_kc_adj_xcell_kc_assoc*.


* rgp_xcell_kc_adj: created in ...
* xcell_kc_assoc: created in ...

* rgp_xcell_kc_adj_xcell_kc_assoc: genes from rgp_xcell_kc_adj minus genes from xcell_kc_assoc


### Let's validate these signatures against QuPath score

Note that there is no Nevus here, so it is not an apples to apples comparison

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_xcell_kc_adj_xcell_kc_assoc'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_rgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  melanoma_enrichment_scores %>%
    filter(complete.cases(detections)) %>%
    mutate(kc_proportion=keratinocyte/detections,
           kc_proportion_asin=asin(sqrt(kc_proportion))) -> data_temp
  
  #lm(var ~ kc_proportion_asin + final_tissue_type_category, 
  #     data=data_temp) -> mod_temp
  
  lmer(var ~ kc_proportion_asin + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
       data=data_temp) -> mod1
  
  #anova(mod_temp, mod1)
  
  mod1 %>%
    emtrends(specs = ~1, var='kc_proportion_asin') %>% as.data.frame() -> mean_ci
  
  mod1 %>%
    emtrends(specs = ~1, var='kc_proportion_asin') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  
}) %>% bind_rows() -> results_all


require(rstatix)

results_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(kc_proportion_asin.trend)) -> results_all

results_all$gene_set <- factor(results_all$gene_set,
                               levels=results_all$gene_set)
  
results_all %>%
  filter(str_detect(gene_set, 'vgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=kc_proportion_asin.trend, 
             y=reorder(gene_set, kc_proportion_asin.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with QuPath KC proportion',
       y='gene set', title='rgp signatures by QC Path KC, LME')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

Let's take a closer look at the model to get some interpretation.

```{r echo=T}

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_xcell_kc_adj_xcell_kc_assoc'

melanoma_enrichment_scores %>%
  filter(complete.cases(detections)) %>%
  mutate(kc_proportion=keratinocyte/detections,
         kc_proportion_asin=asin(sqrt(kc_proportion))) -> data_temp

lmer(gsva_rgp_xcell_kc_adj_xcell_kc_assoc ~ kc_proportion_asin + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
     data=data_temp) -> mod3

summary(mod3)


```


```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)
require(rstatix)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

# we are doing arcsin() transformation on the xcell_keratinocytes score, so it is no longer 0-1 bound 

melanoma_enrichment_scores %>%
  filter(complete.cases(detections)) %>%
  mutate(kc_proportion=keratinocyte/detections,
         kc_proportion_asin=asin(sqrt(kc_proportion))) -> data_temp

data_temp %>%
  select(kc_proportion_asin, starts_with('gsva_rgp')) %>%
  cor_test(vars = 'kc_proportion_asin',
           method = "pearson") -> corr_results_rgp


corr_results_rgp %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(cor)) -> corr_results_rgp

corr_results_rgp$gene_set <- factor(corr_results_rgp$var2,
                               levels=corr_results_rgp$var2)
  
corr_results_rgp %>%
  filter(str_detect(gene_set, 'vgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=cor, 
             y=reorder(gene_set, cor),
             color=p.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  xlim(-1, 1)+
  geom_point()+
  theme_classic()+
  labs(x='pearson cor with xCell KC score',
       y='gene set', title='rgp signatures by QuPath KC correlation')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

## Let's check association with oncogenic MAPK

```{r eval=T}

require(lme4)
require(emmeans)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_xcell_kc_adj_xcell_kc_assoc'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_rgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  lmer(var ~ gsva_MAPK_onco_reactome + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
       data=melanoma_enrichment_scores) -> mod1
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_MAPK_onco_reactome') %>% as.data.frame() -> mean_ci
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_MAPK_onco_reactome') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  return(results_temp)
  
  
}) %>% bind_rows() -> results_mapk_all

require(rstatix)

results_mapk_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(gsva_MAPK_onco_reactome.trend)) -> results_mapk_all

results_mapk_all %>%
  filter(str_detect(gene_set, 'vgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=gsva_MAPK_onco_reactome.trend, 
             y=reorder(gene_set, gsva_MAPK_onco_reactome.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with MAPK onco GSVA score',
       y='gene set', 
       title='rgp genesets vs MAPK oncogenic')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

## Let's valdate against canonical KC score

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_canonical_keratinocte'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_rgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  lmer(var ~ gsva_canonical_kc + final_tissue_type_category  + age_centered_impute + sex + (1|patient_id), 
       data=melanoma_enrichment_scores) -> mod1
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_canonical_kc') %>% as.data.frame() -> mean_ci
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_canonical_kc') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  
}) %>% bind_rows() -> results_all


require(rstatix)

results_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(gsva_canonical_kc.trend)) -> results_all

results_all$gene_set <- factor(results_all$gene_set,
                               levels=results_all$gene_set)
  
results_all %>%
  filter(str_detect(gene_set, 'vgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=gsva_canonical_kc.trend, 
             y=reorder(gene_set, gsva_canonical_kc.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with canonical KC score',
       y='gene set', title='rgp signatures by canonical KC')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

## Let's repeat the above analysis for VGP

Here we screen our signatures for association with xCell KC scores.

1. We do this using linear mixed-effects models, focusing on vgp

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_vgp_canonical_kc_adj'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_vgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  # we are doing arcsin() transformation on the xcell_keratinocytes score, so it is no longer 0-1 bound 
  
  melanoma_enrichment_scores$asin_xcell_keratinocytes <- asin(sqrt(melanoma_enrichment_scores$xcell_keratinocytes))
  
  lmer(var ~ asin_xcell_keratinocytes + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
       data=melanoma_enrichment_scores) -> mod3
  
  mod3 %>%
    emtrends(specs = ~1, var='asin_xcell_keratinocytes') %>% as.data.frame() -> mean_ci
  
  mod3 %>%
    emtrends(specs = ~1, var='asin_xcell_keratinocytes') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  return(results_temp)
  
  
}) %>% bind_rows() -> results_all


require(rstatix)

results_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(asin_xcell_keratinocytes.trend)) -> results_all

results_all$gene_set <- factor(results_all$gene_set,
                               levels=results_all$gene_set)
  
results_all %>%
  filter(str_detect(gene_set, 'rgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=asin_xcell_keratinocytes.trend, 
             y=reorder(gene_set, asin_xcell_keratinocytes.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with xCell KC score',
       y='gene set', title='vgp signatures by xCell KC, LME')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

2. We can also check this using pearson correlation.

This will be less precise as it won't account for covariates.

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)
require(rstatix)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_vgp_canonical_kc_adj'

# we are doing arcsin() transformation on the xcell_keratinocytes score, so it is no longer 0-1 bound 

melanoma_enrichment_scores$asin_xcell_keratinocytes <- asin(sqrt(melanoma_enrichment_scores$xcell_keratinocytes))

melanoma_enrichment_scores %>%
  select(asin_xcell_keratinocytes, starts_with('gsva_vgp')) %>%
  cor_test(vars = 'asin_xcell_keratinocytes',
           method = "pearson") -> corr_results_rgp


corr_results_rgp %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(cor)) -> corr_results_rgp

corr_results_rgp$gene_set <- factor(corr_results_rgp$var2,
                               levels=corr_results_rgp$var2)
  
corr_results_rgp %>%
  filter(str_detect(gene_set, 'rgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=cor, 
             y=reorder(gene_set, cor),
             color=p.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  xlim(-1, 1)+
  geom_point()+
  theme_classic()+
  labs(x='pearson cor with xCell KC score',
       y='gene set', title='vgp signatures by xCell KC correlation')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

The signature with the least association with xcell KC score was *gsva_rgp_xcell_kc_adj_xcell_kc_assoc*.


* rgp_xcell_kc_adj: created in ...
* xcell_kc_assoc: created in ...

* rgp_xcell_kc_adj_xcell_kc_assoc: genes from rgp_xcell_kc_adj minus genes from xcell_kc_assoc


### Let's validate these signatures against QuPath score

Note that there is no Nevus here, so it is not an apples to apples comparison

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_vgp_xcell_kc_adj_xcell_kc_assoc'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_vgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  melanoma_enrichment_scores %>%
    filter(complete.cases(detections)) %>%
    mutate(kc_proportion=keratinocyte/detections,
           kc_proportion_asin=asin(sqrt(kc_proportion))) -> data_temp
  
  #lm(var ~ kc_proportion_asin + final_tissue_type_category, 
  #     data=data_temp) -> mod_temp
  
  lmer(var ~ kc_proportion_asin + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
       data=data_temp) -> mod1
  
  #anova(mod_temp, mod1)
  
  mod1 %>%
    emtrends(specs = ~1, var='kc_proportion_asin') %>% as.data.frame() -> mean_ci
  
  mod1 %>%
    emtrends(specs = ~1, var='kc_proportion_asin') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  
}) %>% bind_rows() -> results_all


require(rstatix)

results_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(kc_proportion_asin.trend)) -> results_all

results_all$gene_set <- factor(results_all$gene_set,
                               levels=results_all$gene_set)
  
results_all %>%
  filter(str_detect(gene_set, 'rgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=kc_proportion_asin.trend, 
             y=reorder(gene_set, kc_proportion_asin.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with QuPath KC proportion',
       y='gene set', title='vgp signatures by QC Path KC proportion')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```


```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)
require(rstatix)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

# we are doing arcsin() transformation on the xcell_keratinocytes score, so it is no longer 0-1 bound 

melanoma_enrichment_scores %>%
  filter(complete.cases(detections)) %>%
  mutate(kc_proportion=keratinocyte/detections,
         kc_proportion_asin=asin(sqrt(kc_proportion))) -> data_temp

data_temp %>%
  select(kc_proportion_asin, starts_with('gsva_vgp')) %>%
  cor_test(vars = 'kc_proportion_asin',
           method = "pearson") -> corr_results_rgp


corr_results_rgp %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(cor)) -> corr_results_rgp

corr_results_rgp$gene_set <- factor(corr_results_rgp$var2,
                               levels=corr_results_rgp$var2)
  
corr_results_rgp %>%
  ggplot(aes(x=cor, 
             y=reorder(gene_set, cor),
             color=p.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  xlim(-1, 1)+
  geom_point()+
  theme_classic()+
  labs(x='pearson cor with QuPath KC score',
       y='gene set', title='vgp signatures by QuPath KC correlation')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

## Let's check association with oncogenic MAPK

```{r eval=T}

require(lme4)
require(emmeans)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_rgp_xcell_kc_adj_xcell_kc_assoc'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_vgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  lmer(var ~ gsva_MAPK_onco_reactome + final_tissue_type_category + age_centered_impute + sex + (1|patient_id), 
       data=melanoma_enrichment_scores) -> mod1
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_MAPK_onco_reactome') %>% as.data.frame() -> mean_ci
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_MAPK_onco_reactome') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  return(results_temp)
  
  
}) %>% bind_rows() -> results_mapk_all

require(rstatix)

results_mapk_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(gsva_MAPK_onco_reactome.trend)) -> results_mapk_all

results_mapk_all %>%
  filter(str_detect(gene_set, 'rgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=gsva_MAPK_onco_reactome.trend, 
             y=reorder(gene_set, gsva_MAPK_onco_reactome.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with MAPK onco GSVA score, LME',
       y='gene set', 
       title='vgp genesets vs MAPK oncogenic')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```

## Let's valdate against canonical KC score

```{r eval=T}

require(lme4)
require(emmeans)
require(tidyverse)

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

L <- 'gsva_canonical_keratinocte'

lapply(str_subset(names(melanoma_enrichment_scores), '^gsva_vgp'), function(L){
  
  melanoma_enrichment_scores$var <- melanoma_enrichment_scores[[L]]
  
  lmer(var ~ gsva_canonical_kc + final_tissue_type_category  + age_centered_impute + sex + (1|patient_id), 
       data=melanoma_enrichment_scores) -> mod1
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_canonical_kc') %>% as.data.frame() -> mean_ci
  
  mod1 %>%
    emtrends(specs = ~1, var='gsva_canonical_kc') %>% 
    test() %>%
    as.data.frame() -> p_val
  
  full_join(x=mean_ci,
            y=p_val) %>%
    mutate(gene_set=L) -> results_temp 
  
  
}) %>% bind_rows() -> results_all


require(rstatix)

results_all %>%
  #adjust_pvalue(method='BH') %>%
  add_significance() %>%
  arrange(desc(gsva_canonical_kc.trend)) -> results_all

results_all$gene_set <- factor(results_all$gene_set,
                               levels=results_all$gene_set)
  
results_all %>%
  filter(str_detect(gene_set, 'rgp|reactome|Reactome', negate = T)) %>%
  ggplot(aes(x=gsva_canonical_kc.trend, 
             y=reorder(gene_set, gsva_canonical_kc.trend),
             color=p.value.signif))+
  geom_vline(xintercept = 0, linetype='dashed')+
  geom_errorbar(aes(xmin=`lower.CL`, xmax=`upper.CL`), width=0)+
  geom_point()+
  theme_classic()+
  labs(x='association with canonical KC score',
       y='gene set', title='vgp signatures by canonical KC, LME')+
  scale_color_manual(values=c(`****`='forestgreen',
                              `***`='forestgreen',
                              `**`='forestgreen',
                              `*`='forestgreen',
                              `ns`='gray50'))


```






## PCA plots exploring KC adjustment

The PCA plot below is adjusted for 

+ mean variance trend (voom)
+ xcell KC score
+ age
+ sex
+ patient-id

```{r eval=T, fig.width=6.8, fig.height=3.7}

# The file below was originally created in data_preparation_and_exploration.Rmd
load('tissue_type_degs_xcell_kc_adjust/results/pca_stuff/fit_reduced_list_for_pca.rda') 

names(form_list)
form_list$form2

# The file below was made in ####
# in contains the results for the xcell-KC association model, db_contrasts
load('genes_associated_with_xcell_kc/results/vobj_fit_contrasts.rda')

names(form_list)
form_list$form2

db_contrasts %>%
  filter(logFC > 1, 
         adj.P.Val < 0.05) %>% .$Symbol -> kc_symbol

# convert to the geneid rather than symbol
vobj$genes %>%
  filter(Symbol %in% kc_symbol,
         complete.cases(GeneID)) %>%
  .$GeneID -> kc_geneid

L <- 'form2'

#form5 = ~ sex + age_centered_impute + Keratinocytes + (1 | patient_id),

residuals_mat <- fit_reduced_list[[L]]$residuals

pca_result <- prcomp(t(residuals_mat), scale. = TRUE)

# Variance for each PC
var_explained <- pca_result$sdev^2

# Proportion of total variance
prop_var_explained <- var_explained / sum(var_explained)

# Convert to %
percent_var <- round(100 * prop_var_explained, 2)

# Optional: label for plotting
pc_labels <- paste0("PC", 1:length(percent_var), " (", percent_var, "%)")

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=final_tissue_type_category))+
  #stat_ellipse()+
  #scale_size_manual(values=c(`OK`=1, `dk_outlier`=3)) +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, xCell KC adjusted'))

```

The PCA plot below is adjusted for 

+ mean variance trend (voom)
+ xcell KC score
+ age
+ sex
+ patient-id

and then selects the Top 500 most variable genes

```{r eval=T, fig.width=6.8, fig.height=3.7}

top_500_var <- sort(apply(residuals_mat, 1, var), decreasing = TRUE)[1:500]

pca_result <- prcomp(t(residuals_mat[names(top_500_var),]), scale. = TRUE)

# Variance for each PC
var_explained <- pca_result$sdev^2

# Proportion of total variance
prop_var_explained <- var_explained / sum(var_explained)

# Convert to %
percent_var <- round(100 * prop_var_explained, 2)

# Optional: label for plotting
pc_labels <- paste0("PC", 1:length(percent_var), " (", percent_var, "%)")

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=final_tissue_type_category))+
  #stat_ellipse()+
  #scale_size_manual(values=c(`OK`=1, `dk_outlier`=3)) +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, xCell KC adjusted, Top 500'))

```

The PCA plot below is adjusted for 

+ mean variance trend (voom)
+ xcell KC score
+ age
+ sex
+ patient-id

and then then removes the ~4,000 genes that are associated with xcell KC score

```{r eval=T, fig.width=6.8, fig.height=3.7}

residuals_mat_no_kc <- residuals_mat[setdiff(rownames(residuals_mat), kc_geneid),]

pca_result <- prcomp(t(residuals_mat_no_kc), scale. = TRUE)

# Variance for each PC
var_explained <- pca_result$sdev^2

# Proportion of total variance
prop_var_explained <- var_explained / sum(var_explained)

# Convert to %
percent_var <- round(100 * prop_var_explained, 2)

# Optional: label for plotting
pc_labels <- paste0("PC", 1:length(percent_var), " (", percent_var, "%)")

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=final_tissue_type_category))+
  #stat_ellipse()+
  #scale_size_manual(values=c(`OK`=1, `dk_outlier`=3)) +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, xCell KC adjusted, KC-genes removed'))


```

The PCA plot below is adjusted for 

+ mean variance trend (voom)
+ xcell KC score
+ age
+ sex
+ patient-id

and then then removes the ~4,000 genes that are associated with xcell KC score

and then selects the Top 500 most variable genes

```{r eval=T, fig.width=6.8, fig.height=3.7}

top_500_var <- sort(apply(residuals_mat_no_kc, 1, var), decreasing = TRUE)[1:500]

pca_result <- prcomp(t(residuals_mat_no_kc[names(top_500_var),]), scale. = TRUE)

# Variance for each PC
var_explained <- pca_result$sdev^2

# Proportion of total variance
prop_var_explained <- var_explained / sum(var_explained)

# Convert to %
percent_var <- round(100 * prop_var_explained, 2)

# Optional: label for plotting
pc_labels <- paste0("PC", 1:length(percent_var), " (", percent_var, "%)")

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=final_tissue_type_category))+
  #stat_ellipse()+
  #scale_size_manual(values=c(`OK`=1, `dk_outlier`=3)) +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, xCell KC adjusted, KC-genes removed, Top 500'))


```

## 

```{r eval=T, fig.width=12, fig.height=12}

# The file below was made in ####
# in contains the results for the xcell-KC association model, db_contrasts
load('genes_associated_with_xcell_kc/results/vobj_fit_contrasts.rda')

db_contrasts %>%
  filter(logFC > 1, 
         adj.P.Val < 0.05) %>% .$Symbol -> kc_symbol

# convert to the geneid rather than symbol
vobj$genes %>%
  filter(Symbol %in% kc_symbol,
         complete.cases(GeneID)) %>%
  .$GeneID -> kc_geneid

load('tissue_type_degs_xcell_kc_adjust/results/vobj_fit_contrasts.rda')

N_DEGs %>% as.data.frame()

db_contrasts %>%
  mutate(KRT=case_when(str_detect(Symbol, 'KRT')~ 'KRT gene',
                               TRUE ~ 'not KRT'),
         Label=case_when(KRT == 'KRT gene' ~ Symbol,
                               TRUE ~ NA_character_)) %>%
  arrange(desc(KRT)) %>% 
  ggplot(aes(x=logFC,
             y=-log10(adj.P.Val),
             color=SIG,
             alpha=SIG,
             size=SIG))+
  geom_point(size=0.2)+
  ggrepel::geom_text_repel(aes(label=Label), max.overlaps=20, show.legend = F, color='black')+
  scale_alpha_manual(values=c(Up=1, Down=1, NS=0.1))+
  scale_size_manual(values=c(`KRT gene`=1, `not KRT`=0.2))+
  scale_color_manual(values=c(Up='red', Down='blue', NS='gray'))+
  geom_hline(yintercept=-log10(0.05), linetype='dotted')+
  geom_vline(xintercept=c(-1, 1), linetype='dotted')+
  facet_wrap(~contrast, nrow=4, scales='free_y')+
  labs(title=paste0('xCell KC adjustment, FCH > 2, FDR < 0.05'))+
  theme_bw() +
  theme(legend.position = 'none') 


```


### The code below addresses the the inconsistencies with previous analysis.

Below shows correlation of RGP signatures with canonical KC.

Remember, correlation is crude, and does not account for covariates and repeated measures.

The LME models used above are more precise.

```{r eval=TRUE, fig.width=10, fig.height=15}

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

require(ggpubr)

melanoma_enrichment_scores %>%
  select(final_tissue_type_category, patient_id, age_centered_impute,  sex, 
         gsva_canonical_kc, contains('gsva_rgp_')) %>%
  pivot_longer(cols=contains('gsva_rgp_')) %>%
  ggplot(aes(y=value,
             x=gsva_canonical_kc))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "pearson", 
           size = 5) + 
  facet_wrap(~name, ncol=3, scales='free')+
  labs(title='pearson correlation of canonoical KC with RGP scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

```


```{r eval=TRUE, fig.width=10, fig.height=15}

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

require(ggpubr)

melanoma_enrichment_scores %>%
  select(final_tissue_type_category, patient_id, age_centered_impute,  sex, 
         gsva_canonical_kc, contains('gsva_vgp_')) %>%
  pivot_longer(cols=contains('gsva_vgp_')) %>%
  ggplot(aes(y=value,
             x=gsva_canonical_kc))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "pearson", 
           size = 5) + 
  facet_wrap(~name, ncol=3, scales='free')+
  labs(title='pearson correlation of canonical KC with VGP scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

```


and below is with spearman,...


```{r eval=TRUE, fig.width=10, fig.height=15}

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

require(ggpubr)

melanoma_enrichment_scores %>%
  select(final_tissue_type_category, patient_id, age_centered_impute,  sex, 
         gsva_canonical_kc, contains('gsva_rgp_')) %>%
  pivot_longer(cols=contains('gsva_rgp_')) %>%
  ggplot(aes(y=value,
             x=gsva_canonical_kc))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name, ncol=3, scales='free')+
  labs(title='spearman correlation of canonoical KC with RGP scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

```


```{r eval=TRUE, fig.width=10, fig.height=15}

load('exploring_melanoma_signatures/results/melanoma_enrichment_scores.rda')

require(ggpubr)

melanoma_enrichment_scores %>%
  select(final_tissue_type_category, patient_id, age_centered_impute,  sex, 
         gsva_canonical_kc, contains('gsva_vgp_')) %>%
  pivot_longer(cols=contains('gsva_vgp_')) %>%
  ggplot(aes(y=value,
             x=gsva_canonical_kc))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name, ncol=3, scales='free')+
  labs(title='spearman correlation of canonical KC with VGP scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

```












## STOP OLD CODE

## Heatmap, No KC adjustment

With clustered columns

FCH > 2, FDR < 0.05

model1 = final_tissue_type_category + sex + age_centered_impute + (1 | patient_id)

```{r eval=F, fig.width=13, fig.height=15}

load('results/xCell_KC_RNAseq_association/vobj_fit_contrasts.rda')

require(pheatmap)

gene_list$no_canonical_GSVA_assoc_custom_adj_rgp_sig -> canonical_signature

vobj$targets -> PHENO

melanoma_enrichment_scores -> PHENO

PHENO %>% 
  arrange(final_tissue_type_category, gsva_MAPK_onco_reactome, patient_id) -> PHENO

require(RColorBrewer)

BREAKS <- seq(-2, 2, by=0.1)

pheatmap(vobj$E[canonical_signature, rownames(PHENO)],
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = F, 
         show_colnames = F,
         annotation_col=PHENO %>% select(final_tissue_type_category, 
                                         gsva_MAPK_onco_reactome),
         cluster_cols = F,
         main='rgp signature with KC canonical-associated genes removed',
         gaps_col = which(!duplicated(PHENO$final_tissue_type_category))[-1]-1,
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple'),
                                  prog_type=c(no_MIS='darkgoldenrod1',
                                              with_MIS='mistyrose1')),
         scale = 'row')

```


```{r eval=F, fig.width=13, fig.height=15}

load('results/xCell_KC_RNAseq_association/vobj_fit_contrasts.rda')

require(pheatmap)

setdiff(gene_list$no_canonical_GSVA_assoc_custom_adj_rgp_sig, 
        gene_list$no_canonical_GSVA_assoc_custom_adj_vgp_sig) -> canonical_signature

vobj$targets -> PHENO

melanoma_enrichment_scores -> PHENO

PHENO %>% 
  arrange(final_tissue_type_category, gsva_MAPK_onco_reactome, patient_id) -> PHENO

require(RColorBrewer)

BREAKS <- seq(-2, 2, by=0.1)

pheatmap(vobj$E[canonical_signature, rownames(PHENO)],
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = F, 
         show_colnames = F,
         annotation_col=PHENO %>% select(final_tissue_type_category, 
                                         gsva_MAPK_onco_reactome),
         cluster_cols = F,
         main='vgp genes removed',
         gaps_col = which(!duplicated(PHENO$final_tissue_type_category))[-1]-1,
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple'),
                                  prog_type=c(no_MIS='darkgoldenrod1',
                                              with_MIS='mistyrose1')),
         scale = 'row')

```




```{r}

load('immune_profiling_results/custom_enrichment_scores/melanoma_enrichment_scores.rda')

require(ggpubr)

colnames(melanoma_enrichment_scores)

melanoma_enrichment_scores %>% 
  pivot_longer(cols=contains("gsva") & contains("rgp")) %>% 
  mutate(name=factor(name, levels=c("gsva_no_adj_rgp_sig", "gsva_custom_adj_rgp_sig", 
                                    "gsva_xcell_adj_rgp_sig", "gsva_nokrt_no_adj_rgp_sig",
                                    "gsva_nokrt_custom_adj_rgp_sig", "gsva_nokrt_xcell_adj_rgp_sig",
                                    "gsva_noxcellassoc_no_adj_rgp_sig",
                                    "gsva_noxcellassoc_custom_adj_rgp_sig", "gsva_noxcellassoc_xcell_adj_rgp_sig"))) %>%
  ggplot(aes(x=asin(sqrt(keratinocyte/detections)),
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores')+
  theme_bw()+
  theme(legend.position = 'bottom')



library(dplyr)
library(purrr)
library(rmcorr)

# assume: df has columns name (facet), id (subject), x, y
melanoma_enrichment_scores %>%
  pivot_longer(cols=contains("gsva") & contains("rgp")) %>% 
  mutate(x=asin(sqrt(keratinocyte/detections))) %>%
  filter(complete.cases(x)) %>%
  group_by(name) %>%
  group_modify(~{
    fit <- rmcorr::rmcorr(
      participant = .x$patient_id,      # subject ID column
      measure1    = .x$x,       # x variable
      measure2    = .x$value,       # y variable
      dataset     = .x
    )
    tibble(
      r_rm = fit$r,
      df   = fit$df,
      p.signif    = fit$p.signif,
      slope= fit$beta            # common slope; optional if you want to use it
    )
  }) %>%
  ungroup() -> rmc_by_name




melanoma_enrichment_scores %>%
  pivot_longer(cols=contains("gsva") & contains("rgp")) %>% 
  mutate(x=asin(sqrt(xcell_keratinocytes))) %>%
  filter(complete.cases(x)) %>%
  group_by(name) %>%
  group_modify(~{
    fit <- rmcorr::rmcorr(
      participant = .x$patient_id,      # subject ID column
      measure1    = .x$x,       # x variable
      measure2    = .x$value,       # y variable
      dataset     = .x
    )
    tibble(
      r_rm = fit$r,
      df   = fit$df,
      p.signif    = fit$p.signif,
      slope= fit$beta            # common slope; optional if you want to use it
    )
  }) %>%
  ungroup() 





melanoma_enrichment_scores %>% 
  pivot_longer(cols=contains("gsva") & contains("rgp")) %>% 
  mutate(name=factor(name, levels=c("gsva_no_adj_rgp_sig", "gsva_custom_adj_rgp_sig", 
                                    "gsva_xcell_adj_rgp_sig", "gsva_nokrt_no_adj_rgp_sig",
                                    "gsva_nokrt_custom_adj_rgp_sig", "gsva_nokrt_xcell_adj_rgp_sig",
                                    "gsva_noxcellassoc_no_adj_rgp_sig",
                                    "gsva_noxcellassoc_custom_adj_rgp_sig", "gsva_noxcellassoc_xcell_adj_rgp_sig"))) %>%
  ggplot(aes(x=xcell_keratinocytes,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores')+
  theme_bw()+
  theme(legend.position = 'bottom')








melanoma_enrichment_scores %>% 
  pivot_longer(cols=contains("gsva") & contains("rgp")) %>%
  ggplot(aes(x=asin(sqrt(keratinocyte/detections)),
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

vobj$targets %>% 
  mutate(final_tissue_type_category = case_when(final_tissue_type_category=='Intermediate' ~ 'Int',
                                                TRUE ~ final_tissue_type_category) %>% 
           factor(levels=c('Nevus', 'Int', 'MIS', 'RGP', 'VGP'))) %>%
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  ggplot(aes(x=final_tissue_type_category,
             y=value,
             color=final_tissue_type_category))+
  geom_boxplot(outliers = F)+
  geom_jitter(size=0.5)+
  facet_wrap(~name)+
  theme_bw()+
  theme(legend.position = 'bottom')+
  labs(x='Tissue Type', y='GSVA-score')

## Specific Melanoma genes?
# MITF, MKI67, and TOP2A 

read_csv('results/signature_db.csv') -> signature_db

signature_db %>% 
  filter(Symbol %in% c('MITF', 'MKI67', 'TOP2A')) %>%
  arrange(gene_set)

vobj$genes %>%
  filter(Symbol %in% c('MITF', 'MKI67', 'TOP2A'))

vobj$targets$MITF <- vobj$E['4286',]
vobj$targets$MKI67 <- vobj$E['4288',]
vobj$targets$TOP2A <- vobj$E['7153',]

#save(fit, vobj, db_contrasts,
#     file='results/model_1_melanoma/vobj_fit_contrasts.rda')

vobj$targets %>% 
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  ggplot(aes(x=MITF,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 4, label.y = 0.75) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores', title='MITF correlation with Melanoma signatures')+
  theme_bw()+
  theme(legend.position = 'bottom')

vobj$targets %>% 
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  ggplot(aes(x=MKI67,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 4, label.y = 0.75) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores', title='MKI67 correlation with Melanoma signatures')+
  theme_bw()+
  theme(legend.position = 'bottom')

vobj$targets %>% 
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  ggplot(aes(x=TOP2A,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 4, label.y = 0.75) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores', title='TOP2A correlation with Melanoma signatures')+
  theme_bw()+
  theme(legend.position = 'bottom')

## What about actual KC counts

vobj$targets %>%
  filter(complete.cases(detections)) %>%
  droplevels.data.frame() %>%
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  mutate(KC_proportion=keratinocyte/detections) %>%
  mutate(arcsin_KC_proportion=asin(sqrt(keratinocyte/detections))) %>%
  ggplot(aes(x=arcsin_KC_proportion,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5,
           label.y = 0.8) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

# Let's do lmer()

vobj$targets %>%
  filter(complete.cases(detections)) %>%
  droplevels.data.frame() %>%
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  mutate(KC_proportion=keratinocyte/detections) %>%
  mutate(arcsin_KC_proportion=asin(sqrt(keratinocyte/detections))) -> db_mod

L='GSVA_rgp_up'

require(rstatix)

lapply(unique(db_mod$name), function(L){

  db_mod %>%
    filter(name==L) %>%
    droplevels.data.frame() -> temp
  
  lmer(value ~ arcsin_KC_proportion + age_centered_impute + sex + (1|patient_id),
       data = temp, REML = TRUE) -> mod3
  
  mod3 %>%
    emtrends(specs= ~1, var='arcsin_KC_proportion') %>% 
    test() %>%
    mutate(score_name=L) %>%
    full_join(y=mod3 %>%
                emtrends(specs= ~1, var='arcsin_KC_proportion') %>% as.data.frame) -> res
  
  return(res)
    
}) %>%
  bind_rows() %>%
  adjust_pvalue() %>%
  add_significance() -> results_db
  
results_db %>%
  mutate(score_name=str_remove(score_name, 'GSVA_')) %>%
  ggplot(aes(x=score_name,
             y=arcsin_KC_proportion.trend,
             color=score_name))+
  geom_hline(yintercept = 0, linetype='dashed')+
  geom_point()+
  geom_errorbar(aes(ymin=`lower.CL`, ymax = `upper.CL`), width=0.2)+
  geom_label(aes(label=p.signif.value.adj.signif), color='black')+
  labs(x='Melanoma-signature name',
       y='Association with KC Percentage (slope, CI95)')+
  theme_bw()+
  coord_flip()

## Assoxiation with Melanoma genes

vobj$targets %>%
  droplevels.data.frame() %>%
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) -> db_mod

L='GSVA_rgp_up'

vobj$genes %>%
  filter(Symbol %in% c('MITF', 'MKI67', 'TOP2A'))

lapply(unique(db_mod$name), function(L){
  
  db_mod %>%
    filter(name==L) %>%
    droplevels.data.frame() -> temp
  
  lmer(value ~ MITF + age_centered_impute + sex + (1|patient_id),
       data = temp, REML = TRUE) -> mod3
  
  mod3 %>%
    emtrends(specs= ~1, var='MITF') %>% 
    test() %>%
    mutate(score_name=L) %>%
    full_join(y=mod3 %>%
                emtrends(specs= ~1, var='MITF') %>% as.data.frame) -> res
  
  return(res)
  
}) %>%
  bind_rows() %>%
  adjust_pvalue() %>%
  add_significance() %>% 
  dplyr::rename(trend=MITF.trend) %>%
  mutate(marker='MITF') -> results_db_MITF

lapply(unique(db_mod$name), function(L){
  
  db_mod %>%
    filter(name==L) %>%
    droplevels.data.frame() -> temp
  
  lmer(value ~ MKI67 + age_centered_impute + sex + (1|patient_id),
       data = temp, REML = TRUE) -> mod3
  
  mod3 %>%
    emtrends(specs= ~1, var='MKI67') %>% 
    test() %>%
    mutate(score_name=L) %>%
    full_join(y=mod3 %>%
                emtrends(specs= ~1, var='MKI67') %>% as.data.frame) -> res
  
  return(res)
  
}) %>%
  bind_rows() %>%
  adjust_pvalue() %>%
  add_significance() %>%
  dplyr::rename(trend=MKI67.trend) %>%
  mutate(marker='MKI67') -> results_db_MKI67

lapply(unique(db_mod$name), function(L){
  
  db_mod %>%
    filter(name==L) %>%
    droplevels.data.frame() -> temp
  
  lmer(value ~ TOP2A + age_centered_impute + sex + (1|patient_id),
       data = temp, REML = TRUE) -> mod3
  
  mod3 %>%
    emtrends(specs= ~1, var='TOP2A') %>% 
    test() %>%
    mutate(score_name=L) %>%
    full_join(y=mod3 %>%
                emtrends(specs= ~1, var='TOP2A') %>% as.data.frame) -> res
  
  return(res)
  
}) %>%
  bind_rows() %>%
  adjust_pvalue() %>%
  add_significance() %>%
  dplyr::rename(trend=TOP2A.trend) %>%
  mutate(marker='TOP2A') -> results_db_TOP2A

results_db_TOP2A %>%
  full_join(y=results_db_MKI67) %>%
  full_join(y=results_db_MITF) -> results_db_mel_markers

  
results_db_mel_markers %>%
  mutate(score_name=str_remove(score_name, 'GSVA_')) %>%
  ggplot(aes(x=score_name,
             y=trend,
             color=score_name))+
  geom_hline(yintercept = 0, linetype='dashed')+
  geom_point()+
  geom_errorbar(aes(ymin=`lower.CL`, ymax = `upper.CL`), width=0.2)+
  geom_text(aes(label=p.signif.value.adj.signif), color='black', size=3, nudge_x = 0.05)+
  labs(x='Melanoma-signature name',
       y='Association with Melanoma Markers (slope, CI95)')+
  theme_bw()+
  facet_wrap(~marker, ncol=3)+
  coord_flip()

```

MAPK


```{r}

load('results/model_1_melanoma/vobj_fit_contrasts.rda')

require(ggpubr)

vobj$targets 

vobj$targets %>% 
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  ggplot(aes(x=GSVA_MAPK_onco_reactome,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores')+
  theme_bw()+
  theme(legend.position = 'bottom')


vobj$targets %>% 
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) %>%
  ggplot(aes(x=GSVA_MAPK_reactome,
             y=value))+
  geom_point(aes(color=final_tissue_type_category))+
  geom_smooth(inherit.aes = T, color='black',
              method = 'lm', linetype='dashed') +
  stat_cor(inherit.aes = T, 
           method = "spearman", 
           size = 5) + 
  facet_wrap(~name)+
  labs(y='Melanoma-signature GSVA scores')+
  theme_bw()+
  theme(legend.position = 'bottom')

vobj$targets %>% 
  mutate(final_tissue_type_category = case_when(final_tissue_type_category=='Intermediate' ~ 'Int',
                                                TRUE ~ final_tissue_type_category) %>% 
           factor(levels=c('Nevus', 'Int', 'MIS', 'RGP', 'VGP'))) %>%
  pivot_longer(cols=c(GSVA_MAPK_reactome, ssGSEA_MAPK_onco_reactome, 
                      GSVA_MAPK_onco_reactome, ssGSEA_MAPK_reactome)) %>%
  ggplot(aes(x=final_tissue_type_category,
             y=value,
             color=final_tissue_type_category))+
  geom_boxplot(outliers = F)+
  geom_jitter(size=0.5)+
  facet_wrap(~name, scales='free')+
  theme_bw()+
  theme(legend.position = 'bottom')+
  labs(x='Tissue Type', y='GSVA-score')

vobj$targets %>%
  droplevels.data.frame() %>%
  pivot_longer(cols=c(GSVA_rgp_up, GSVA_rgp_up_kc_adj, GSVA_rgp_up_kc_adjxCell,
                      GSVA_vgp_up, GSVA_vgp_up_kc_adj, GSVA_vgp_up_kc_adjxCell)) -> db_mod

L <- 'GSVA_rgp_up'

require(lme4)
require(rstatix)
require(emmeans)

lapply(unique(db_mod$name), function(L){
  
  db_mod %>%
    filter(name==L) %>%
    droplevels.data.frame() -> temp
  
  lmer(value ~ GSVA_MAPK_onco_reactome + age_centered_impute + sex + (1|patient_id),
       data = temp, REML = TRUE) -> mod3
  
  mod3 %>%
    emtrends(specs= ~1, var='GSVA_MAPK_onco_reactome') %>% 
    test() %>%
    mutate(score_name=L) %>%
    full_join(y=mod3 %>%
                emtrends(specs= ~1, var='GSVA_MAPK_onco_reactome') %>% as.data.frame) -> res
  
  return(res)
  
}) %>%
  bind_rows() %>%
  adjust_pvalue() %>%
  add_significance() -> results_db


results_db %>%
  mutate(score_name=str_remove(score_name, 'GSVA_')) %>%
  ggplot(aes(x=score_name,
             y=GSVA_MAPK_onco_reactome.trend,
             color=score_name))+
  geom_hline(yintercept = 0, linetype='dashed')+
  geom_point()+
  geom_errorbar(aes(ymin=`lower.CL`, ymax = `upper.CL`), width=0.2)+
  geom_text(aes(label=p.signif.value.adj.signif), color='black', size=3, nudge_x = 0.05)+
  labs(x='Melanoma-signature name',
       y='Association with MAPK_onco_reactome (slope, CI95)')+
  theme_bw()+
  coord_flip()



```

```{r}

# This code has been moved to 'ssgsea_gsva_on_additional signatures

load('data/processed/DGE_final_samples.rda')

dge_final <- calcNormFactors(dge_final)

log_cpm <- cpm(dge_final, log = TRUE, prior.count = 1)

name_vec <- dge_final$genes$GeneID 
names(name_vec) <- dge_final$genes$Symbol

read_csv('data/Danaher_Signature.csv') %>%
  filter(Selected == 1) -> immune_infiltration

reactome_sets <- msigdbr(species = "Homo sapiens", 
                         collection = "C2") %>%
  filter(str_detect(gs_name, 'REACTOME')) %>%
  dplyr::select(gs_name, gene_symbol)

reactome_list <- split(reactome_sets$gene_symbol, reactome_sets$gs_name)

keratinocyte_gene_list <- c('KRT1', 'KRT2', 'KRT5', 'KRT10', 'KRT14', 'IVL', 'FLG', 'LOR', 'TGM3', 
                            'SPRR2A', 'DSG1', 'DSC1', 'PI3', 'DMKN')

gene_list_pt2 <- list(NMD_Reactome = name_vec[reactome_list$REACTOME_NONSENSE_MEDIATED_DECAY_NMD],
                      MAPK_onco_reactome = name_vec[reactome_list$REACTOME_ONCOGENIC_MAPK_SIGNALING],
                      MAPK_reactome = name_vec[reactome_list$REACTOME_MAPK_FAMILY_SIGNALING_CASCADES],
                      immune_infiltration = name_vec[immune_infiltration$Gene],
                      canonical_keratinocte = name_vec[keratinocyte_gene_list])

lapply(gene_list_pt2, function(L){
  
  vec=L[complete.cases(L)]
  
}) -> gene_list_pt2



```

