---
title: "model2 (progression-type) xCell KC-adj DEGs"
author: "Lewis E Tomalin, PhD"
date: "2025-06-26"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      eval = FALSE,
                      message = FALSE,
                      warning = FALSE)

require(tableone)
require(tidyverse)
require(variancePartition)

```

## This script fits model1 with KC adjustment, using the xCell KC signature

FCH > 2, FDR < 0.05

+ Variance partitian
+ numbers or DEGs for each contrast
+ volcano plots
+ heatmaps
+ venn diagrams

```{r}

load('data/processed/DGE_final_samples.rda')

dge <- dge_final

dge <- calcNormFactors(dge)

design <- model.matrix(~ final_tissue_type_category + sex + age_centered_impute, 
                       data = dge$samples)

keep <- filterByExpr(dge, 
                     design = design, 
                     min.count = 25,
                     min.prob = 1)

table(keep)

dge <- dge[keep, , keep.lib.sizes = FALSE]

table(keep)

keep2 <- grepl("Nevus|VGP|RGP", dge$samples$final_tissue_type_category)  
dge <- dge[, keep2]

dge <- calcNormFactors(dge)

#save(dge, file='data/processed/DGE.rda')

read_delim('immune_profiling_results/xCell_Analysis/xcell_results/xCell_exprs_for_xcell_xCell_1938061125.txt') %>%
  rename(cell_id=...1) %>% 
  column_to_rownames('cell_id') %>%
  t() -> cell_data

colnames(cell_data)

dge$samples

dge$samples$prog_type %>% table()

dge$samples <- bind_cols(dge$samples, cell_data[rownames(dge$samples), 'Keratinocytes', drop=F])

# Define formula
form <- ~ prog_type * final_tissue_type_category + sex + age_centered_impute + Keratinocytes + (1 | patient_id)

# Optional: speed up computation
#register(SnowParam(20)) # or use SnowParam for Windows
#bpparam()

# For Mac
library(BiocParallel)
#bp <- MulticoreParam(8) 
bp <- SnowParam(8) 

## Need to explore missing a little more...

dge$samples %>% dim()

vobj <- voomWithDreamWeights(dge, 
                             formula=form, 
                             data = dge$samples,
                             plot = TRUE,
                             save.plot = TRUE,
                             BPPARAM = bp)


register(SerialParam())

# Define contrast:
contrast_matrix <- makeContrastsDream(
  VGP_vs_Nevus_no_MIS = 'final_tissue_type_categoryVGP',
  RGP_vs_Nevus_no_MIS = 'final_tissue_type_categoryRGP',
  data=vobj$targets,
  formula = form
)

contrast_matrix

contrast_matrix[,'VGP_vs_Nevus_no_MIS']

Mean_VGPwithMIS <- c(INT=1, 
                     prog_typewith_MIS=1, 
                     final_tissue_type_categoryRGP=0, 
                     final_tissue_type_categoryVGP=1, 
                     sexMale=0, 
                     age_centered_impute=0, 
                     Keratinocytes=0, 
                     `prog_typewith_MIS:final_tissue_type_categoryRGP`=0,
                     `prog_typewith_MIS:final_tissue_type_categoryVGP`=1)


Mean_VGP_noMIS <-  c(INT=1, 
                     prog_typewith_MIS=0, 
                     final_tissue_type_categoryRGP=0, 
                     final_tissue_type_categoryVGP=1, 
                     sexMale=0, 
                     age_centered_impute=0, 
                     Keratinocytes=0, 
                     `prog_typewith_MIS:final_tissue_type_categoryRGP`=0,
                     `prog_typewith_MIS:final_tissue_type_categoryVGP`=0)

MIS_vs_no_MIS_VGP <- Mean_VGPwithMIS - Mean_VGP_noMIS
contrast_matrix <- cbind(contrast_matrix, MIS_vs_no_MIS_VGP)

# Visualize contrast matrix
plotContrasts(contrast_matrix)

Mean_RGPwithMIS <- c(INT=1, 
                     prog_typewith_MIS=1, 
                     final_tissue_type_categoryRGP=1, 
                     final_tissue_type_categoryVGP=0, 
                     sexMale=0, 
                     age_centered_impute=0, 
                     Keratinocytes=0, 
                     `prog_typewith_MIS:final_tissue_type_categoryRGP`=1,
                     `prog_typewith_MIS:final_tissue_type_categoryVGP`=0)

Mean_RGP_noMIS <-  c(INT=1, 
                     prog_typewith_MIS=0, 
                     final_tissue_type_categoryRGP=1, 
                     final_tissue_type_categoryVGP=0, 
                     sexMale=0, 
                     age_centered_impute=0, 
                     Keratinocytes=0, 
                     `prog_typewith_MIS:final_tissue_type_categoryRGP`=0,
                     `prog_typewith_MIS:final_tissue_type_categoryVGP`=0)

MIS_vs_no_MIS_RGP <- Mean_RGPwithMIS - Mean_RGP_noMIS
contrast_matrix <- cbind(contrast_matrix, MIS_vs_no_MIS_RGP)

# Visualize contrast matrix
plotContrasts(contrast_matrix)

Mean_Nevus_withMIS <- c(INT=1, 
                        prog_typewith_MIS=1, 
                        final_tissue_type_categoryRGP=0, 
                        final_tissue_type_categoryVGP=0, 
                        sexMale=0, 
                        age_centered_impute=0, 
                        Keratinocytes=0, 
                        `prog_typewith_MIS:final_tissue_type_categoryRGP`=0,
                        `prog_typewith_MIS:final_tissue_type_categoryVGP`=0)


RGP_vs_Nevus_with_MIS <- Mean_RGPwithMIS - Mean_Nevus_withMIS
VGP_vs_Nevus_with_MIS <- Mean_VGPwithMIS - Mean_Nevus_withMIS

contrast_matrix <- cbind(contrast_matrix, RGP_vs_Nevus_with_MIS)
contrast_matrix <- cbind(contrast_matrix, VGP_vs_Nevus_with_MIS)

# Visualize contrast matrix
plotContrasts(contrast_matrix)

vobj$targets$final_tissue_type_category

# Visualize contrast matrix
plotContrasts(contrast_matrix)

fit_contrast <- dream(vobj$E, 
                      formula=form, 
                      data=vobj$targets,
                      BPPARAM = bp,
                      contrast_matrix)

fit <- variancePartition::eBayes(fit_contrast, trend = F)

save(fit, vobj, dge,
     file='results/model_2_progtype/vobj_fit_contrasts.rda')

```


```{r}


load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

dge$genes -> Annot

head(Annot)

fit$coefficients %>% colnames()

COEFS <- c('VGP_vs_Nevus_no_MIS',
           'RGP_vs_Nevus_no_MIS',
           'MIS_vs_no_MIS_VGP',
           'MIS_vs_no_MIS_RGP',
           'VGP_vs_Nevus_with_MIS',
           'RGP_vs_Nevus_with_MIS',
           'prog_typewith_MIS')

L <- 'VGP_vs_Nevus_no_MIS'

lapply(COEFS, function(L){

# Compare Mel vs Nevus Low
topTable(fit, 
         coef = L, 
         adjust.method = "fdr",
         p.value = 1,
         number = Inf) %>% 
  mutate(DIRECTION=sign(logFC),
         SIG=case_when(logFC > 1 & adj.P.Val <= 0.05 ~ 'Up',
                       logFC < -1 &  adj.P.Val <= 0.05 ~ 'Down',
                       TRUE ~ 'NS')) %>%
  rownames_to_column('GeneID') %>% 
  mutate(contrast=L) -> temp
  
  return(temp)
  
}) -> contr_list

contr_list %>%
  purrr::reduce(full_join) %>%
  left_join(Annot) %>%
  mutate(contrast=factor(contrast, 
                         levels=c('VGP_vs_Nevus_no_MIS',
                                  'RGP_vs_Nevus_no_MIS',
                                  'MIS_vs_no_MIS_VGP',
                                  'MIS_vs_no_MIS_RGP',
                                  'VGP_vs_Nevus_with_MIS',
                                  'RGP_vs_Nevus_with_MIS',
                                  'prog_typewith_MIS'))) -> db_contrasts

db_contrasts %>%
  group_by(SIG, contrast) %>%
  summarise(COUNT=n()) %>% 
  pivot_wider(id_cols = contrast,
              names_from = SIG,
              values_from = COUNT) -> N_DEGs

save(fit, vobj, dge, db_contrasts, N_DEGs,
     file='results/model_2_progtype/vobj_fit_contrasts.rda')




```
 
```{r}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

# For Mac
library(BiocParallel)
bp <- MulticoreParam(8) 
#bp <- SnowParam(12) 

varPart <- fitExtractVarPartModel(vobj, 
                                  formula =  ~ (1 | patient_id) + 
                                    (1 | sex) + 
                                    (1 | final_tissue_type_category) + 
                                    (1|prog_type) + 
                                    (1|prog_type:final_tissue_type_category),
                                  vobj$targets,
                                  BPPARAM = bp)

save(fit, vobj, db_contrasts, N_DEGs, varPart,
    file='results/model_2_progtype/vobj_fit_contrasts.rda')

```

## Variance Partition

```{r eval=T, fig.width=6, fig.height=4}

load('results/model_2_progtype/vobj_fit_contrasts.rda')

plotVarPart(varPart[,c("sex", "prog_type", "patient_id", 
                       "final_tissue_type_category", 
                       "prog_type:final_tissue_type_category", 
                       "Residuals" )])

```


## Volcano plots

```{r eval=T, fig.width=12, fig.height=8.5}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

N_DEGs %>% as.data.frame()

db_contrasts %>%
  filter(SIG == 'Up') %>%
  arrange(desc(logFC)) %>%
  group_by(contrast) %>%
  slice_head(n = 5) %>% .$Symbol %>% unique() -> Top5_DEGs_Up

db_contrasts %>%
  filter(SIG == 'Down') %>%
  arrange(logFC) %>%
  #group_by(contrast) %>%
  slice_head(n = 5) %>% .$Symbol %>% unique() -> Top5_DEGs_Down

db_contrasts %>%
  mutate(Top10=case_when(Symbol %in% c(Top5_DEGs_Up, Top5_DEGs_Down) ~ Symbol,
                         TRUE ~ NA_character_)) %>%
  ggplot(aes(x=logFC,
             y=-log10(adj.P.Val),
             color=SIG))+
  geom_point(size=0.2)+
  ggrepel::geom_text_repel(aes(label=Top10), max.overlaps=20, show.legend = F, color='black')+
  #scale_alpha_manual(values=c(Up=1, Down=1, NS=0.1))+
  scale_color_manual(values=c(Up='red', Down='blue', NS='gray'))+
  geom_hline(yintercept=-log10(0.05), linetype='dotted')+
  geom_vline(xintercept=c(-1, 1), linetype='dotted')+
  facet_wrap(~contrast)+
  labs(title=paste0('Model2 prog-type Nev VGP RGP xCell KCadj, FCH>2, FDR<0.05'))+
  theme_bw()

```


```{r eval=T, fig.width=12, fig.height=8.5}

## Lets get Top5 for each comparison

db_contrasts %>%
  filter(SIG == 'Up') %>%
  arrange(desc(logFC)) %>%
  group_by(contrast) %>%
  slice_head(n = 5) %>%
  mutate(Top5=Symbol) %>%
  select(SIG, contrast, Symbol, Top5) -> Top5_DEGs_Up

db_contrasts %>%
  filter(SIG == 'Down') %>%
  arrange(logFC) %>%
  group_by(contrast) %>%
  slice_head(n = 5) %>% 
  mutate(Top5=Symbol) %>%
  select(SIG, contrast, Symbol, Top5) -> Top5_DEGs_Down

db_contrasts %>% 
  full_join(bind_rows(Top5_DEGs_Up, Top5_DEGs_Down)) -> db_contrasts

db_contrasts$contrast %>% table()

db_contrasts %>%
  filter(contrast %in% c('VGP_vs_Nevus_no_MIS', 'RGP_vs_Nevus_no_MIS', 
                         'VGP_vs_Nevus_with_MIS', 'prog_typewith_MIS')) %>%
  ggplot(aes(x=logFC,
             y=-log10(adj.P.Val),
             color=SIG,
             alpha=SIG))+
  geom_point(size=0.2)+
  ggrepel::geom_text_repel(aes(label=Top5), 
                           max.overlaps=20, 
                           show.legend = F, color='black')+
  scale_alpha_manual(values=c(Up=1, Down=1, NS=0.1))+
  scale_color_manual(values=c(Up='red', Down='blue', NS='gray'))+
  geom_hline(yintercept=-log10(0.05), linetype='dotted')+
  geom_vline(xintercept=c(-1, 1), linetype='dotted')+
  facet_wrap(~contrast)+
  labs(title=paste0('Model2 prog-type Nev VGP RGP xCell KCadj, FCH>2, FDR<0.05'))+
  theme_bw()

```

## Heatmaps

```{r eval=T, fig.width=13, fig.height=15}

require(pheatmap)

db_contrasts %>%
  filter(SIG !='NS',
         complete.cases(Symbol)) %>% 
  .$GeneID %>% unique() -> AllDEGs

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

vobj$targets -> PHENO

PHENO %>% 
  arrange(final_tissue_type_category, prog_type, patient_id) -> PHENO

require(RColorBrewer)

BREAKS <- seq(-2, 2, by=0.1)

pheatmap(vobj$E[AllDEGs, rownames(PHENO)],
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = F, 
         show_colnames = F,
         annotation_col=PHENO %>% select(final_tissue_type_category, prog_type),
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple'),
                                  prog_type=c(no_MIS='darkgoldenrod1',
                                              with_MIS='mistyrose1')),
         cluster_cols = F,
         main='All DEGs Mel vs Nev by Progression Type',
         gaps_col = which(!duplicated(PHENO$final_tissue_type_category))[-1]-1,
         scale = 'row')



```

## Heatmap with columns clusters

```{r eval=T, fig.width=13, fig.height=15}


pheatmap(vobj$E[AllDEGs, rownames(PHENO)],
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = F, 
         show_colnames = F,
         annotation_col=PHENO %>% select(final_tissue_type_category, prog_type),
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple'),
                                  prog_type=c(no_MIS='darkgoldenrod1',
                                              with_MIS='mistyrose1')),
         cluster_cols = T,
         main='All DEGs Mel vs Nev by Progression Type',
         gaps_col = which(!duplicated(PHENO$final_tissue_type_category))[-1]-1,
         scale = 'row')



```

## Venn diagrams

### vs Nevus Up

```{r eval=T, fig.width=6, fig.height=6, fig.show='hold'}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

db_contrasts %>%
  filter(SIG == 'Up') %>%
  arrange(desc(logFC)) %>%
  group_by(contrast) %>%
  slice_head(n = 5) %>%
  mutate(Top5=Symbol) %>%
  select(SIG, contrast, Symbol, Top5) -> Top5_DEGs_Up

db_contrasts %>%
  filter(SIG == 'Up',
         !is.na(Symbol)) -> UP

db_contrasts %>%
  filter(SIG == 'Down',
         !is.na(Symbol)) -> DOWN

#UP$contrast %>% table()
#DOWN$contrast %>% table()

library(VennDiagram)
library(grid)

# Create Venn diagram object (do not save to file)
venn_obj <- venn.diagram(
  x = list(
    Up_VGP_vs_Nevus_no_MIS = UP$GeneID[UP$contrast == 'VGP_vs_Nevus_no_MIS'],
    Up_RGP_vs_Nevus_no_MIS = UP$GeneID[UP$contrast == 'RGP_vs_Nevus_no_MIS'],
    Up_VGP_vs_Nevus_with_MIS = UP$GeneID[UP$contrast == 'VGP_vs_Nevus_with_MIS']
  ),
  filename = NULL,  # Don't write to file
  fill = c(Up_VGP_vs_Nevus_no_MIS = 'orange', 
           Up_RGP_vs_Nevus_no_MIS = 'red', 
           Up_VGP_vs_Nevus_with_MIS = 'purple'),
  alpha = 0.5,
  cex = 1.5,
  cat.cex = 1.2,
  cat.pos = 0
)

# Draw the Venn diagram to the RMarkdown output
grid.newpage()
grid.draw(venn_obj)

```


### vs Nevus Down

```{r eval=T, fig.width=6, fig.height=6, fig.show='hold'}


venn.plot <- venn.diagram(
  x = list(
    Down_VGP_vs_Nevus_no_MIS = DOWN$GeneID[DOWN$contrast == 'VGP_vs_Nevus_no_MIS'],
    Down_RGP_vs_Nevus_no_MIS = DOWN$GeneID[DOWN$contrast == 'RGP_vs_Nevus_no_MIS'],
    Down_VGP_vs_Nevus_with_MIS = DOWN$GeneID[DOWN$contrast == 'VGP_vs_Nevus_with_MIS']
  ),
  filename = NULL,
  fill = c(Down_MISvsNev='orange', Down_RGPvsNev='red', Down_VGPvsNev='purple'),
  alpha = 0.5,
  cex = 1.5,
  cat.cex = 1.2,
  cat.pos = 0
)

# Draw the Venn diagram to the RMarkdown output
grid.newpage()
grid.draw(venn.plot )


```


## GSEA analysis

```{r}

library(fgsea)
library(msigdbr)
library(tidyverse)

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

hallmark_sets <- msigdbr(species = "Homo sapiens", collection = "H")

colnames(hallmark_sets)

head(hallmark_sets)  

hallmark_sets$gs_name %>% unique()

hallmark_sets %>% str()

hallmark_sets %>% 
  filter(gs_name == 'HALLMARK_MYOGENESIS')

# Create a list where each element is a vector of genes for a pathway
hallmark_list <- split(hallmark_sets$gene_symbol, hallmark_sets$gs_name)

L = 'Mel_vs_Nevus'

lapply(unique(db_contrasts$contrast), function(L){

db_contrasts %>% 
  filter(contrast == L,
         complete.cases(Symbol)) -> dream_results

# Example: using t-statistic
ranks <- dream_results %>%
  dplyr::filter(!is.na(t)) %>%
  dplyr::arrange(desc(t)) %>%
  dplyr::select(Symbol, t)

# Create a named vector for fgsea
ranked_genes <- setNames(ranks$t, ranks$Symbol)

fgsea_res <- fgsea(pathways = hallmark_list,
                   stats = ranked_genes,
                   minSize = 15,
                   maxSize = 500,
                   nproc = 1)

# Top pathways
fgsea_res <- fgsea_res[order(fgsea_res$pval), ]

fgsea_res$contrast <- L

return(fgsea_res)

}) %>% 
  bind_rows() -> fgsea_res_HK

#write.csv(fgsea_res_HK %>% 
#            select(-leadingEdge), 
#          file="results/model_1_melanoma/gsea_stuff/fgsea_hallmark_results.csv", row.names = FALSE)

save(fit, vobj, db_contrasts, N_DEGs, varPart, fgsea_res_HK,
    file='results/model_2_progtype/vobj_fit_contrasts.rda')

```


```{r eval=T, fig.width=10, fig.height=12}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

fgsea_res_HK %>%
  filter(padj <= 0.1) %>% 
  .$pathway %>% 
  unique() -> SIG_PATH

fgsea_res_HK %>% 
  filter(pathway %in% SIG_PATH) %>%
  select(-leadingEdge) %>%
  pivot_wider(id_cols = pathway,
              values_from = NES,
              names_from = contrast) %>%
  mutate(pathway=str_remove(pathway, 'HALLMARK_')) %>%
  column_to_rownames('pathway') -> mat

fgsea_res_HK %>% 
  rstatix::add_significance(p.col = 'padj',
                            cutpoints = c(0, 1e-04, 0.001, 0.01, 0.05, 1),
                            symbols = c("****", "***", "**", "*", "")) %>%
  filter(pathway %in% SIG_PATH) %>%
  select(-leadingEdge) %>%
  pivot_wider(id_cols = pathway,
              values_from = padj.signif,
              names_from = contrast) %>%
  mutate(pathway=str_remove(pathway, 'HALLMARK_')) %>%
  column_to_rownames('pathway') -> STARS

BREAKS <- seq(-3, 3, by=0.1)

require(RColorBrewer)
require(pheatmap)

#dev.off()
#pdf('results/model_1_melanoma/gsea_stuff/HallmarkHeatmap.pdf', width=8, height=12)
pheatmap(mat,
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = T,
         display_numbers = STARS,
         cluster_cols = T,
         cellheight = 12,
         cellwidth = 25,
         main='Hallmark Enrichment, FDR < 0.1')
#dev.off()

```



```{r}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

reactome_sets <- msigdbr(species = "Homo sapiens", 
                         collection = "C2") %>%
  filter(str_detect(gs_name, 'REACTOME')) %>%
  dplyr::select(gs_name, gene_symbol)

# Create a list where each element is a vector of genes for a pathway
reactome_list <- split(reactome_sets$gene_symbol, reactome_sets$gs_name)

L <- "Mel_vs_Nevus"

lapply(unique(db_contrasts$contrast), function(L){
  
  db_contrasts %>% 
    filter(contrast == L,
           complete.cases(Symbol)) -> dream_results
  
  # Example: using t-statistic
  ranks <- dream_results %>%
    dplyr::filter(!is.na(t)) %>%
    dplyr::arrange(desc(t)) %>%
    dplyr::select(Symbol, t)
  
  # Create a named vector for fgsea
  ranked_genes <- setNames(ranks$t, ranks$Symbol)
  
  fgsea_res <- fgsea(pathways = reactome_list,
                     stats = ranked_genes,
                     minSize = 15,
                     maxSize = 500,
                     nproc = 8)
  
  # Top pathways
  fgsea_res <- fgsea_res[order(fgsea_res$pval), ]
  
  fgsea_res$contrast <- L
  
  return(fgsea_res)
  
}) %>% 
  bind_rows() -> fgsea_res_REACTOME

#write.csv(fgsea_res_REACTOME %>% 
#            select(-leadingEdge), 
#          file="results/model_1_melanoma/gsea_stuff/fgsea_reactome_results.csv", row.names = FALSE)

save(fit, vobj, db_contrasts, N_DEGs, varPart, fgsea_res_HK, fgsea_res_REACTOME,
     file='results/model_2_progtype/vobj_fit_contrasts.rda')


```

### Reactome Top 5 up and down (per contrast)


```{r eval=T, fig.width=16, fig.height=13}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

## Reactome Heatmap

fgsea_res_REACTOME %>%
  filter(padj <= 0.1) %>% 
  arrange(NES) %>%
  group_by(contrast) %>%
  slice_head(n=5) %>%
  .$pathway %>% 
  unique() -> SIG_PATH_DOWN

fgsea_res_REACTOME %>%
  filter(padj <= 0.1) %>% 
  arrange(desc(NES)) %>%
  group_by(contrast) %>%
    slice_head(n=5) %>%
  .$pathway %>% 
  unique() -> SIG_PATH_UP

SIG_PATH <- unique(c(SIG_PATH_UP, SIG_PATH_DOWN))

fgsea_res_REACTOME %>% 
  filter(pathway %in% SIG_PATH) %>%
  select(-leadingEdge) %>%
  pivot_wider(id_cols = pathway,
              values_from = NES,
              names_from = contrast) %>%
  mutate(pathway=str_remove(pathway, 'REACTOME_')) %>%
  column_to_rownames('pathway') -> mat

fgsea_res_REACTOME %>% 
  rstatix::add_significance(p.col = 'padj',
                            cutpoints = c(0, 1e-04, 0.001, 0.01, 0.05, 1),
                            symbols = c("****", "***", "**", "*", "")) %>%
  filter(pathway %in% SIG_PATH) %>%
  select(-leadingEdge) %>%
  pivot_wider(id_cols = pathway,
              values_from = padj.signif,
              names_from = contrast) %>%
  mutate(pathway=str_remove(pathway, 'REACTOME_')) %>%
  column_to_rownames('pathway') -> STARS

BREAKS <- seq(-3, 3, by=0.1)

require(RColorBrewer)

#dev.off()
#pdf('results/model_1_melanoma/gsea_stuff/ReactomeHeatmap.pdf', width=16, height=10)
pheatmap(mat,
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = T,
         display_numbers = STARS,
         cluster_cols = T,
         cellheight = 12,
         cellwidth = 25,
         main='Reactome Enrichment')
#dev.off()

```


### Reactome all


```{r eval=T, fig.width=16, fig.height=140}

load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

## Reactome Heatmap

fgsea_res_REACTOME %>%
  filter(padj <= 0.1) %>% 
  arrange(NES) %>%
  group_by(contrast) %>%
  .$pathway %>% 
  unique() -> SIG_PATH_DOWN

fgsea_res_REACTOME %>%
  filter(padj <= 0.1) %>% 
  arrange(desc(NES)) %>%
  group_by(contrast) %>%
  .$pathway %>% 
  unique() -> SIG_PATH_UP

SIG_PATH <- unique(c(SIG_PATH_UP, SIG_PATH_DOWN))

fgsea_res_REACTOME %>% 
  filter(pathway %in% SIG_PATH) %>%
  select(-leadingEdge) %>%
  pivot_wider(id_cols = pathway,
              values_from = NES,
              names_from = contrast) %>%
  mutate(pathway=str_remove(pathway, 'REACTOME_')) %>%
  column_to_rownames('pathway') -> mat

fgsea_res_REACTOME %>% 
  rstatix::add_significance(p.col = 'padj',
                            cutpoints = c(0, 1e-04, 0.001, 0.01, 0.05, 1),
                            symbols = c("****", "***", "**", "*", "")) %>%
  filter(pathway %in% SIG_PATH) %>%
  select(-leadingEdge) %>%
  pivot_wider(id_cols = pathway,
              values_from = padj.signif,
              names_from = contrast) %>%
  mutate(pathway=str_remove(pathway, 'REACTOME_')) %>%
  column_to_rownames('pathway') -> STARS

BREAKS <- seq(-3, 3, by=0.1)

require(RColorBrewer)

#dev.off()
#pdf('results/model_1_melanoma/gsea_stuff/ReactomeHeatmap.pdf', width=16, height=10)
pheatmap(mat,
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = T,
         display_numbers = STARS,
         cluster_cols = T,
         cellheight = 12,
         cellwidth = 25,
         main='Reactome Enrichment')
#dev.off()

```


```{r eval=T, fig.width=13, fig.height=8}


load(file='results/model_2_progtype/vobj_fit_contrasts.rda')

# Plot a specific enrichment
#plotEnrichment(reactome_list[["REACTOME_NONSENSE_MEDIATED_DECAY_NMD"]], ranked_genes)

#fgsea_res_all %>% 
#  select(-leadingEdge) %>%
#  filter(pathway=="REACTOME_NONSENSE_MEDIATED_DECAY_NMD") %>%
#  arrange(NES)

fgsea_res_REACTOME %>% 
  filter(pathway=="REACTOME_NONSENSE_MEDIATED_DECAY_NMD") %>% .$leadingEdge -> Ledge

Ledge %>%
  reduce(unique) -> Ledge

require(msigdbr)

reactome_sets <- msigdbr(species = "Homo sapiens", 
                         collection = "C2") %>%
  filter(str_detect(gs_name, 'REACTOME')) %>%
  dplyr::select(gs_name, gene_symbol)

# Create a list where each element is a vector of genes for a pathway
reactome_list <- split(reactome_sets$gene_symbol, reactome_sets$gs_name)

reactome_list$REACTOME_NONSENSE_MEDIATED_DECAY_NMD -> PTWY

## Volcano plots

db_contrasts %>%
  filter(contrast != 'DeltaVGP_MIS_VS_DeltaVGP_RGP') %>%
  #mutate(adj.P.Val=case_when(contrast == 'RGP_vs_MIS' & adj.P.Val < 0.5 ~ 1,
  #                           TRUE ~ adj.P.Val)) %>%
  mutate(LeadingEdge=case_when(Symbol %in% Ledge ~ 'LeadingEdge',
                               Symbol %in% PTWY ~ 'Pathway',
                               TRUE ~ 'No'),
         Label=case_when(LeadingEdge == 'LeadingEdge' ~ Symbol,
                               TRUE ~ NA_character_)) %>%
  mutate(LeadingEdge = factor(LeadingEdge, levels = c("No", "Pathway", "LeadingEdge"))) %>%
  arrange(LeadingEdge) %>% 
  ggplot(aes(x=logFC,
             y=-log10(adj.P.Val),
             color=LeadingEdge))+
  geom_point(aes(size=LeadingEdge))+
  #ggrepel::geom_text_repel(aes(label=Label), max.overlaps=20, show.legend = F, color='black')+
  #scale_alpha_manual(values=c(Up=1, Down=1, NS=0.1))+
  scale_size_manual(values=c(LeadingEdge=1, Pathway=1, No=0.2))+
  scale_color_manual(values=c(LeadingEdge='forestgreen', Pathway='blue', No='gray'))+
  #geom_hline(yintercept=-log10(0.05), linetype='dotted')+
  geom_vline(xintercept=c(-1, 1), linetype='dotted')+
  facet_wrap(~contrast, scales='free')+
  labs(title=paste0('NMD genes highlighted'))+
  theme_bw() 


```







## STOP HERE

Code below has been moved

PCA plot

```{r}

require(tidyverse)
library(variancePartition)
library(lme4)

load('results/model_2_progtype/vobj_fit_contrasts.rda')

library(BiocParallel)
#bp <- MulticoreParam(8) 
bp <- SnowParam(8) 

#reduced_form <- ~ 1
#reduced_form <- ~ (1|patient_id)
#reduced_form <- ~ Keratinocytes
#reduced_form <- ~ Keratinocytes + (1|patient_id)
#reduced_form <- ~ sex + age_centered_impute + Keratinocytes + (1 | patient_id)
#reduced_form <- ~ sex + age_centered_impute + final_tissue_type_category + Keratinocytes + (1|patient_id)

form_list <- list(form =  ~ sex + age_centered_impute + Keratinocytes + (1 | patient_id))

lapply(names(form_list), function(L){
  
  print(L)
  
  reduced_form = form_list[[L]]
  
  fit_reduced = dream(vobj$E, 
                      formula = reduced_form,
                      data = vobj$targets,
                      BPPARAM = bp)
  
  return(fit_reduced)}) -> fit_reduced_list

names(fit_reduced_list) <- names(form_list) 

L <- 'form'

lapply(names(form_list) , function(L){
  
  print(L)
  
  fit_reduced_list[[L]]$residuals

residuals_mat <- fit_reduced_list[[L]]$residuals

pca_result <- prcomp(t(residuals_mat), scale. = TRUE)

# Variance for each PC
var_explained <- pca_result$sdev^2

# Proportion of total variance
prop_var_explained <- var_explained / sum(var_explained)

# Convert to %
percent_var <- round(100 * prop_var_explained, 2)

# Optional: label for plotting
pc_labels <- paste0("PC", 1:length(percent_var), " (", percent_var, "%)")

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=final_tissue_type_category))+
  #stat_ellipse()+
  #scale_size_manual(values=c(`OK`=1, `dk_outlier`=3)) +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, ', L))

#ggsave(file=paste0('results/PCA_on_adjusted_data/xCell_adj_plots/PCA_adj_tissue_',L,'.tiff'),
#       width = 5.6, height=3)

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=prog_type))+
  #stat_ellipse()+
  #scale_size_manual(values=c(`OK`=1, `dk_outlier`=3)) +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, ', L))

#ggsave(file=paste0('results/PCA_on_adjusted_data/xCell_adj_plots/PCA_adj_patientid_',L,'.tiff'),
#       width = 5.6, height=3)

pca_result$x %>% 
  bind_cols(vobj$targets) %>%
  mutate(Keratinocytes_scaled = as.numeric(scale(Keratinocytes, center = TRUE, scale = TRUE))) %>%
  ggplot(aes(x=PC1, y=PC2,
             color=Keratinocytes))+
  #stat_ellipse(aes(group=final_tissue_type_category))+
  #scale_color_gradient2(low = 'blue', mid = 'white', high='red', midpoint = 0) +
    scale_color_viridis_c() +
  geom_point(size=1)+
  xlab(pc_labels[1]) +
  ylab(pc_labels[2]) +
  theme_minimal()+
  labs(title=paste0('PCA, ', L))

#ggsave(file=paste0('results/PCA_on_adjusted_data/xCell_adj_plots/PCA_adj_KC_',L,'.tiff'),
#       width = 5.6, height=3)


})





```





Adjusting for KC score

```{r}

db_contrasts %>%
  filter(contrast %in% c('VGP_vs_Nevus'),
         SIG == 'Up') %>% .$GeneID %>% unique() -> VGPUpSigKCadjxCell

db_contrasts %>%
  filter(contrast %in% c('RGP_vs_Nevus'),
         SIG == 'Up') %>% .$GeneID %>% unique() -> RGPUpSigKCadjxCell

save(VGPUpSigKCadjxCell, RGPUpSigKCadjxCell,
     file='results/model_6_xCellKC_adjust/KC_adjusted_Melanoma_scores.rda')


load('results/model_6_KC_adjust/vobj_fit_contrasts.rda')

read_csv('data/Danaher_Signature.csv') %>%
  filter(Selected == 1) -> immune_infiltration

load('data/processed/DGE_final_samples.rda')

dge <- dge_final
dge <- calcNormFactors(dge)
log_cpm <- cpm(dge, log = TRUE, prior.count = 1, normalized.lib.sizes = T)

reactome_sets <- msigdbr(species = "Homo sapiens", 
                         collection = "C2") %>%
  filter(str_detect(gs_name, 'REACTOME')) %>%
  dplyr::select(gs_name, gene_symbol)

reactome_sets$gs_name %>% unique()

# Create a list where each element is a vector of genes for a pathway
reactome_list <- split(reactome_sets$gene_symbol, reactome_sets$gs_name)

keratinocyte_gene_list <- c('KRT1', 'KRT2', 'KRT5', 'KRT10', 'KRT14', 'IVL', 'FLG', 'LOR', 'TGM3', 
                            'SPRR2A', 'DSG1', 'DSC1', 'PI3', 'DMKN')

name_vec <- dge$genes$GeneID 
names(name_vec) <- dge$genes$Symbol

keratinocyte_gene_list_id <- name_vec[keratinocyte_gene_list]

reactome_list$REACTOME_NONSENSE_MEDIATED_DECAY_NMD

intersect(MelUpSig, keratinocyte_gene_list_id[complete.cases(keratinocyte_gene_list_id)])

setdiff(MelUpSig, keratinocyte_gene_list_id[complete.cases(keratinocyte_gene_list_id)]) -> MelUpSigNoKC

str_subset(names(reactome_list), 'NMD')

custom_genes <- list(KC = keratinocyte_gene_list_id[complete.cases(keratinocyte_gene_list_id)],
                     NMD_Reactome = name_vec[reactome_list$REACTOME_NONSENSE_MEDIATED_DECAY_NMD],
                     immune_infiltration = name_vec[immune_infiltration$Gene],
                     melanoma_up = MelUpSig,
                     melanoma_up_noKC = MelUpSigNoKC)

log_cpm

require(GSVA)
  
# Create parameter object for ssGSEA
ssgsea_params <- GSVA::ssgseaParam(exprData= log_cpm,
                                   geneSets= custom_genes)

# Run GSVA with ssGSEA method
kc_ssgsea_scores <- gsva(param = ssgsea_params)

kc_ssgsea_scores %>% str()

kc_ssgsea_scores %>% 
  as.data.frame() -> kc_ssgsea_scores

rownames(kc_ssgsea_scores) <- paste0('ssGSEA_', rownames(kc_ssgsea_scores))
  
gsva_params <- GSVA::gsvaParam(exprData= log_cpm,
                               geneSets= custom_genes)

kc_gsva_scores <- gsva(param = gsva_params)

kc_gsva_scores %>% 
  as.data.frame() -> kc_gsva_scores

rownames(kc_gsva_scores) <- paste0('GSVA_', rownames(kc_gsva_scores))

custom_enrichment <- bind_rows(kc_gsva_scores, 
                               kc_ssgsea_scores)

#save(custom_enrichment,
#     file='immune_profiling_results/custom_enrichment_scores/custom_enrichment.rda')

custom_enrichment %>% 
  t() -> custom_enrichment

vobj$targets <- vobj$targets %>% select(-contains('ssGSEA'), -contains('GSVA'))

vobj$targets <- bind_cols(vobj$targets, custom_enrichment[rownames(vobj$targets),])

save(fit, vobj, db_contrasts,
     file='results/model_6_KC_adjust/vobj_fit_contrasts.rda')

vobj$targets %>%
  ggplot(aes(x=GSVA_KC,
             y=GSVA_melanoma_up_noKC,
             color=final_tissue_type_category))+
  geom_point()+
  theme_bw()

vobj$targets %>%
  ggplot(aes(x=GSVA_KC,
             y=GSVA_melanoma_up,
             color=final_tissue_type_category))+
  geom_point()+
  theme_bw()

vobj$targets %>%
  ggplot(aes(x=ssGSEA_KC,
             y=ssGSEA_melanoma_up,
             color=final_tissue_type_category))+
  geom_point()+
  theme_bw()


vobj$targets %>%
  ggplot(aes(x=final_tissue_type_category,
             y=ssGSEA_melanoma_up,
             color=final_tissue_type_category))+
  geom_boxplot()+
  geom_jitter()+
  theme_bw()+
  labs(title='ssGSEA Melanoma Up score')
  
vobj$targets %>%
  ggplot(aes(x=final_tissue_type_category,
             y=GSVA_melanoma_up,
             color=final_tissue_type_category))+
  geom_boxplot()+
  geom_jitter()+
  theme_bw()+
  labs(title='GSVA Melanoma Up score')




```
