---
title: "Data Exploration Diego"
author: "Lewis E Tomalin"
date: "2025-03-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      eval = FALSE,
                      message = FALSE,
                      warning = FALSE)

require(tableone)
require(tidyverse)
require(pheatmap)
require(RColorBrewer)
require(lme4)
require(emmeans)
require(rstatix)
require(ggpubr)

```

### Running xCell

The chunk below prepares the data set used to calculate xcell scores.

You will need to upload the file *exprs_for_xcell.txt* to the xcell web tool.

https://aran-lab.com/software/xcell/

```{r echo=TRUE}

load('data/processed/DGE_final_samples.rda')

dge_final <- calcNormFactors(dge_final)

cpm <- cpm(dge_final, log = FALSE)

cpm %>%
  as.data.frame() %>%
  rownames_to_column('GeneID') %>%
  full_join(y=dge_final$genes) %>%
  relocate(Symbol, .before = GeneID) %>%
  filter(complete.cases(Symbol)) %>%
  column_to_rownames('Symbol') %>%
  select(-GeneID) -> exprs_for_xCell

exprs_for_xCell

exprs_for_xCell %>%
  write.table(file='data/xcell_input/exprs_for_xcell.txt',
              sep = '\t')


```


This script requires:

'data/processed/DGE_final_samples.rda' 

'data/xcell_output/xCell_exprs_for_xcell_xCell_1448071725.txt'

This script creates: 

'data/immune_profiles/xcell_data.rda'


```{r}

load('data/processed/DGE_final_samples.rda')

dge_final$samples -> sample_data

sample_data$sample <- rownames(sample_data)

# This data was output by the xcell tool
read_delim('data/xcell_output/xCell_exprs_for_xcell_xCell_1448071725.txt') %>%
  rename(cell_id=...1)-> cell_data

cell_data %>%
  pivot_longer(cols=2:last_col(),
               names_to = 'sample',
               values_to = 'enrichment') -> cell_data


cell_sample_data <- inner_join(x=sample_data,
                               y=cell_data) %>%
  filter(final_tissue_type_category != 'Regressed-Area') %>%
  mutate(final_tissue_type_category= factor(final_tissue_type_category,
                                            levels=c('Nevus', 'Intermediate', 'MIS',
                                                     'RGP', 'VGP')))

cell_sample_data %>%
  mutate(cell_id=paste0('cell_', cell_id)) %>%
  pivot_wider(id_cols = c(patient_id, prog_type, sample, 
                          age, sex, age_centered, age_centered_impute, 
                          final_tissue_type_category),
              names_from = cell_id,
              values_from = enrichment) -> cell_sample_data

save(cell_sample_data, 
     file='data/processed/xcell_data.rda')
  


```


#### Sanity check

The numbers in the tables below should be consistent across all reports. 

If there are differences, this will indicate that 'data/processed/DGE_final_samples.rda' is not up to date.

```{r eval=TRUE}

load('data/processed/DGE_final_samples.rda')

CreateTableOne(vars=c('age', 'sex', 'prog_type', 
                      'csd', 'solar_elastosis_score', 'age_centered', 'age_centered_impute'),
               data=dge_final$samples %>%
                 filter(!duplicated(patient_id)),
                addOverall = TRUE)

CreateTableOne(vars=c('final_tissue_type_category'),
               data=dge_final$samples,
                addOverall = TRUE)

```


Heatmap

```{r eval=TRUE, fig.width=20, fig.height=12}

load(file='data/processed/xcell_data.rda')


cell_sample_data %>%
  column_to_rownames('sample') %>%
  select(!contains('cell_')) -> columun_annots

columun_annots %>% 
  arrange(final_tissue_type_category, prog_type, patient_id) -> columun_annots

cell_sample_data %>%
  column_to_rownames('sample') %>%
  select(contains('cell_')) %>%
  t() -> mat_prop

BREAKS <- seq(0, 0.4, by=0.01)

#dev.off()
#pdf('immune_profiling_results/xCell_Analysis/heatmaps/cell_enrichment_no_scaling.pdf', width=20, height=12)
pheatmap(mat_prop[, rownames(columun_annots)],
         breaks = BREAKS,
         color = colorRampPalette(brewer.pal(n = 8, name ="Greens"))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = F,
         annotation_col = select(columun_annots, final_tissue_type_category, prog_type),
         cluster_cols = F,
         cluster_rows=T, 
         main='cell enrichment, no scaling',
         cellwidth = 10,
         cellheight = 10,
         gaps_col = which(!duplicated(columun_annots$final_tissue_type_category))[-1]-1,
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple'),
                                  prog_type=c(no_MIS='darkgoldenrod1',
                                              with_MIS='mistyrose1')),
         scale = 'none')
#dev.off()


BREAKS <- seq(-2, 2, by=0.1)



#dev.off()
#pdf('immune_profiling_results/xCell_Analysis/heatmaps/cell_enrichment_scaled.pdf', width=20, height=12)
pheatmap(mat_prop[, rownames(columun_annots)],
         breaks = BREAKS,
         color = colorRampPalette(c('blue', 'white', 'red'))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = F,
         annotation_col = select(columun_annots, final_tissue_type_category, prog_type),
         cluster_cols = F,
         cluster_rows=T, 
         main='cell enrichment, with scaling',
         cellwidth = 10,
         cellheight = 10,
         gaps_col = which(!duplicated(columun_annots$final_tissue_type_category))[-1]-1,
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                      Intermediate='yellow',
                                                      MIS='orange',
                                                      RGP='red',
                                                      VGP='purple'),
                                  prog_type=c(no_MIS='darkgoldenrod1',
                                              with_MIS='mistyrose1')),
         scale = 'row')
#dev.off()



```


# jitter plots granular

```{r eval=TRUE, fig.width=16, fig.height=40}

load(file='data/processed/xcell_data.rda')

cell_sample_data %>%
  pivot_longer(cols=contains('cell_'),
               names_to = 'cell_type',
               values_to = 'enrichment') %>%
  mutate(cell_type = str_remove(cell_type, 'cell_')) -> db_plot

i = 'Th2 cells' 

# for(i in unique(db_plot$cell_type)){
#   
#   print(i)
#   
#   pos_jitter <- position_jitter(width = 0.25, height = 0, seed=1987)
#   
#   db_plot %>%
#     filter(cell_type == i) %>%
#     ggplot(aes(x = final_tissue_type_category, 
#                y = enrichment,
#                color = final_tissue_type_category)) +
#     geom_boxplot(outliers = F)+
#     #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
#     #geom_point(size = 0.5, position = pos_jitter) +
#     geom_jitter(width=0.25, size=0.5)+
#     labs(title = paste0(i, ' enrichment'), x=NULL) +
#     theme_bw()
#   
#   ggsave(file=paste0('immune_profiling_results/xCell_Analysis/boxplots/box_plots_enrichment',i,'.tiff'),
#          width=5.6, height=2.92)
#   
# 
#   
# }


db_plot %>%
  mutate(final_tissue_type_category=case_when(final_tissue_type_category == 'Intermediate' ~ 'Inter',
                                              TRUE ~ final_tissue_type_category) %>% factor(levels=c('Nevus', 'Inter', 'MIS', 'RGP', 'VGP'))) %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('enrichment'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  facet_wrap(~cell_type, scales='free', ncol=4)+
  theme_bw()

#ggsave(file=paste0('immune_profiling_results/xCell_Analysis/boxplots/xcell_enrichment_all.tiff'),
#       width=20, height=12)


```

Do stats on xCell

```{r eval=TRUE, fig.width=16, fig.height=40}



db_plot %>%
  mutate(final_tissue_type_category=case_when(final_tissue_type_category=='Intermediate' ~ 'Inter',
                                     TRUE ~ final_tissue_type_category) %>% 
           factor(levels=c('Nevus', 'Inter', 'MIS',
                           'RGP', 'VGP'))) -> db_plot


L = 'Astrocytes'

lapply(unique(db_plot$cell_type), function(L){
  
  #print(L)
  
  db_plot %>%
    filter(cell_type == L) %>%
    mutate(var_trans=qnorm((rank(enrichment) - 0.5) / sum(!is.na(enrichment)))) -> temp
  
  lmer(var_trans ~ final_tissue_type_category + age_centered_impute + 
         sex + (1|patient_id),
       data=temp) -> mod1
  
  mod1 %>%
    emmeans(specs='final_tissue_type_category',
            contr='revpairwise', adjust='BH') %>% 
    .$contrasts %>% as.data.frame() %>%
    mutate(cell_type=L,
           group1=str_split(contrast, ' - ', simplify = T)[,1],
           group2=str_split(contrast, ' - ', simplify = T)[,2]) -> results
  
  temp %>% 
    group_by(final_tissue_type_category) %>%
    summarise(y.position=max(enrichment)) -> max_db
  
  results %>%
    dplyr::select(contrast, group1, group2) %>%
    pivot_longer(cols=group1:group2,
                 values_to = 'final_tissue_type_category') %>%
    full_join(y=max_db) %>%
    group_by(contrast) %>%
    filter(y.position==max(y.position)) %>%
    dplyr::select(contrast, y.position)  %>%
    full_join(y=results) -> results
    
return(results)
  
  
}) %>% 
  bind_rows() -> results_db

results_db %>%
  #adjust_pvalue(method = 'fdr') %>%
  add_significance(cutpoints = c(0, 0.001, 0.01, 0.05, 1),
                   symbols = c("***", "**", "*", "ns")) -> results_db

results_db %>% 
  filter(p.value.signif != 'ns') %>% 
  group_by(cell_type, y.position) %>%
  mutate(
    dup_id = row_number(), 
    y.position.staggered = y.position + (y.position/2) * (dup_id - 1)
  ) %>%
  ungroup() -> results_db_filter

db_plot %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('xCell Enrichment scores'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position.staggered',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=4)+
  theme_bw()

#ggsave(file=paste0('immune_profiling_results/xCell_Analysis/boxplots/xcell_enrichment_all.tiff'),
#       width=20, height=12)

db_xcell <- db_plot
results_db_xcell <- results_db

save(db_xcell, results_db_xcell,
     file='results/xcell_stats_data.rda')

```


```{r eval=TRUE, fig.width=6, fig.height=4}


db_plot %>%
  filter(cell_type == 'Keratinocytes') %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('xCell Enrichment score'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter %>%
                       filter(cell_type=='Keratinocytes') , 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     step.increase = 0.1,
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=4)+
  theme_bw()

```
   
   
```{r eval = TRUE, fig.width=9, fig.height=3}


db_plot %>%
  filter(str_detect(cell_type, 'Macrophages')) %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('xCell Enrichment score'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter %>%
                        filter(str_detect(cell_type, 'Macrophages')), 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     step.increase = 0.1,
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=4)+
  theme_bw()

```


```{r eval = TRUE, fig.width=9, fig.height=5}

db_plot %>%
  filter(str_detect(cell_type, 'CD4+')) %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('xCell Enrichment score'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter %>%
                        filter(str_detect(cell_type, 'CD4+')), 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     step.increase = 0.1,
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=3)+
  theme_bw()

```


```{r eval = TRUE, fig.width=9, fig.height=5}

db_plot %>%
  filter(str_detect(cell_type, 'DC')) %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('xCell Enrichment score'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter %>%
                        filter(str_detect(cell_type, 'DC')), 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     step.increase = 0.1,
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=3)+
  theme_bw()

```



```{r eval = TRUE, fig.width=9, fig.height=5}

db_plot %>%
  filter(cell_type %in% c('Keratinocytes', 'Melanocytes', 'Endothelial cells', 'MSC', 'Fibroblasts', 'Adipocytes')) %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = enrichment,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('xCell Enrichment score'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter %>%
                       filter(cell_type %in% c('Keratinocytes', 'Melanocytes', 'Endothelial cells', 
                                               'MSC', 'Fibroblasts', 'Adipocytes')) , 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     step.increase = 0.05,
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=3)+
  theme_bw()

```


### STOP CODE BELOW NO LONGER IN USE

```{r}

# Mixed effects Dirichlet regression
# No need to use this, I was just exploring for fun
# Yes, I find this fun.

library(DirichletReg)
# Suppose df is your data.frame:
# - composition: matrix/data.frame of compositional data (rows = samples, columns = cell types)
# - group: grouping variable (e.g. case/control)
# - patient_id: patient identifier

# Convert to DirichletReg format
comp <- DR_data(df[,c("A", "B", "C")])  # replace with your cell type columns

db_stats_prop %>%
  mutate(proportion=case_when(proportion==0 ~ proportion+1e-5,
                              TRUE ~ proportion)) %>%
  group_by(sample) %>%
  mutate(
    prop_sum = sum(proportion),
    proportion = proportion / prop_sum
  ) %>%
  ungroup() %>%
  select(-prop_sum) %>%
  pivot_wider(id_cols=c(patient_id, sample, final_tissue_type_category, sex_change_impute, age_centered_impute),
              names_from = cell_type,
              values_from = proportion) -> df

comp <- DR_data(df %>% select(b_naive:last_col()))  

# Standard regression
fit <- DirichletReg::DirichReg(comp ~ final_tissue_type_category, data = df, 
                               model='alternative')
summary(fit)

library(brms)
library(future)

N=12

plan(multisession, workers = N) # on Windows


fit <- brm(
  bf(cbind(b_naive, b_mem, plasma, t_cd8, t_cd4_naive, t_cd4_mem_rest, t_cd4_mem_act,
           t_folli_hel, t_reg, t_g_d, nk_rest, nk_act, mono, macro_m0, macro_m1, macro_m2, 
           dendritic_rest, dendritic_act, mast_rest, mast_act, eosinophils, neutrophils) ~ final_tissue_type_category + (1|patient_id), 
     family = dirichlet()),
  data = df,
  chains = N, cores = N)

summary(fit)

rownames(fixef(fit))

ranef(fit)
VarCorr(fit)

save(fit, file='immune_profiling_results/me_dirichlet_fit.rda')


library(brms)
# The names may look like 'final_tissue_typeVGP:t_cd4_mem_act'
hypothesis(fit, "mutcd4memact_final_tissue_typeIntermediate - mutcd4memact_final_tissue_typeMIS = 0")

hypothesis(fit, "mutcd4memact_final_tissue_typeVGP = 0") %>% .$hypothesis

rownames(fixef(fit)) %>%
  str_subset('_Intercept|sex_change_impute|age_centered_impute', negate = T) %>%
  paste0(' = 0') -> contr_list

str_split(contr_list, '_', simplify = T)[,1] %>% str_remove_all('mu')
paste0(str_extract(contr_list, 'Inter|MIS|RGP|VGP'), ' - Nevus')

contr_nevus <- data.frame(contrast_brm=contr_list) %>%
  mutate(celltype=str_split(contrast_brm, '_', simplify = T)[,1] %>% str_remove_all('mu'),
         contrast=paste0(str_extract(contrast_brm, 'Inter|MIS|RGP|VGP'), ' - Nevus'))


expand.grid(celltype=str_remove_all(unique(db_stats_prop$cell_type), pattern = '_'),
            final_tissue_type_category=c('Inter', 'MIS', 'RGP', 'VGP')) %>%
  mutate(coef=paste0(celltype, '_final_tissue_type', final_tissue_type_category)) %>%
  filter(celltype != 'bnaive') -> coef_db

L = 'macrom1'

lapply(unique(coef_db$celltype), function(L){
  
  coef_db %>%
    filter(celltype==L) -> temp
  
  combn(temp$coef, 2, FUN = function(x) paste0('mu',x[1], " - mu", x[2], " = 0")) -> contrasts_brm
  
  combn(temp$coef, 2, FUN = function(x) paste0(x[1], " - ", x[2])) %>%
    str_remove_all(as.character(L)) %>%
    str_remove_all('_final_tissue_type') -> contrasts
  
  db_contr <- data.frame(contrast_brm=contrasts_brm,
                         celltype=L,
                         contrast=contrasts)
  
  return(db_contr)
  
  }) %>% bind_rows() -> contrast_list

names(contrast_list)
names(contr_nevus)

contrast_list <- rbind(contrast_list, contr_nevus)

L="mubnaive_final_tissue_typeInter - mubnaive_final_tissue_typeMIS = 0"

L=1

lapply(1:nrow(contrast_list), function(L){
  
  contrast_list[L,] -> temp
  
  hypothesis(fit, temp$contrast_brm) %>% 
    .$hypothesis %>%
    mutate(celltype=temp$celltype,
           contrast=temp$contrast) -> res
  
  return(res)
  
}) %>% bind_rows() -> brm_contrasts

brm_contrasts %>%
  select(-Hypothesis) %>%
  filter(Star=='*') %>%
  arrange(celltype)

brm_contrasts %>%
  select(-Hypothesis) %>%
  filter(Star=='*') %>%
  mutate(group1=str_split(contrast, ' - ', simplify = T)[,1],
         group2=str_split(contrast, ' - ', simplify = T)[,2],
         contrast_rev=paste0(group2, ' - ', group1)) %>%
  pivot_longer(cols=c(contrast, contrast_rev),
               values_to = 'contrast') %>%
  filter(contrast %in% results_db$contrast) %>%
  select(-name) %>%
  mutate(group1=str_split(contrast, ' - ', simplify = T)[,1],
         group2=str_split(contrast, ' - ', simplify = T)[,2]) -> db_results_brm

db_results_brm %>%
  filter(celltype=='tcd4memact') %>% as.data.frame()
  
  db_results_brm$contrast %>% unique() %>% sort()
  results_db$contrast %>% unique() %>% sort()
  
  setdiff(db_results_brm$contrast, results_db$contrast) %>% sort()

results_db %>%
  mutate(celltype=str_remove_all(cell_type, '_')) %>%
  select(contrast, y.position, cell_type, celltype) %>%
  inner_join(y=db_results_brm) %>%
  group_by(cell_type, y.position) %>%
  mutate(
    dup_id = row_number(), 
    y.position.staggered = y.position + (y.position/2) * (dup_id - 1)
  ) %>%
  ungroup() -> results_db_filter


results_db_filter %>%
  filter(cell_type=='t_cd4_mem_act') %>% as.data.frame()


db_stats_prop %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = proportion,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('compositional, dirichlet regression'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'Star',
                     hide.ns = TRUE,
                     y.position = 'y.position.staggered',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free')+
  theme_bw()

ggsave(file=paste0('immune_profiling_results/box_plots_granular_noline/compositional_dirichlet_all_noline.tiff'),
       width=12, height=7.44)


```












