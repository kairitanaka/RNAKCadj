---
title: "Calculate & Explore ssGSEA & GSVA Enrichment scores for Davids signatures"
author: "Lewis E Tomalin"
date: "2025-03-26"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      eval = FALSE,
                      message = FALSE,
                      warning = FALSE)

require(tableone)
require(tidyverse)
require(variancePartition)
library(GSVA)
library(msigdbr)
require(lme4)
require(emmeans)
require(rstatix)
require(ggpubr)
require(edgeR)

```

requires data: 

'data/processed/DGE_final_samples.rda' 
'data/raw/gene_signatures_with_APMs_IFNG.Symbol.txt'

creates data:

'data/processed/db_ssGSEA_David_correct.rda' 
'data/processed/db_GSVA_David_correct.rda'


## Summary

This script does the following

+ Calculates and saves enrichment scores (ssGSEA & GSVA) for Davids immune-cell signatures
+ This includes re-calculation of IIL and TIL (immune_infiltration_David, tcell_infiltration_David)
+ Performs statistical analysis and makes plots

The enrichment calculations are performed on log cpm + 1.

No genes were filtered out prior to enrichment score calculations.

The stars represent adjusted p-values. (adjustment is performed within each signature using Benjamini-Hochberg).

It has not been adjusted across gene-sets (ie we are not treating this as a screen)

NOTE: You need to run the first chunk before knitting (you only need to do this once)

```{r}

## Run this chunk once before you can knit

load('data/processed/DGE_final_samples.rda')

dge_final <- calcNormFactors(dge_final)

log_cpm <- cpm(dge_final, log = TRUE, prior.count = 1)

dge_final$genes %>%
  filter(complete.cases(Symbol)) -> annots_tab

name_vec <- dge_final$genes$GeneID 
names(name_vec) <- dge_final$genes$Symbol

read_delim('data/raw/gene_signatures_with_APMs_IFNG.Symbol.txt') %>%
  mutate(SymByID=name_vec[SymByEntrez]) %>%
  group_by(`Cell.Type`) %>%
  summarise(items = list(as.character(SymByID)), .groups = "drop") %>%
  deframe() -> geneset_list

# Create parameter object for ssGSEA
ssgsea_params <- GSVA::ssgseaParam(exprData = log_cpm,
                                   geneSets = geneset_list, 
                                   minSize = 1)

ssgsea_score_results <-  gsva(param = ssgsea_params)

dge_final$samples %>%
  as.data.frame() -> meta_data

ssgsea_score_results %>% 
  as.data.frame() %>% t() -> ssgsea_score_results

cbind(meta_data, ssgsea_score_results[rownames(meta_data),]) -> db_ssGSEA_David_correct

db_ssGSEA_David_correct

db_ssGSEA_David_correct %>%
  as.data.frame() %>%
  select(aDC, `B cells`, `Cytotoxic cells`, DC, Eosinophils, iDC, Macrophages, `Mast cells`,
         Neutrophils, `NK CD56bright cells`, `NK CD56dim cells`, `NK cells`, pDC, `CD8 T cells`,
         `T cells`, `T helper cells`, `Tcm cells`, `Tem cells`, `Th1 cells`, `Th17 cells`,
         `Th2 cells`, `Treg cells`) %>%
  rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "GeneSet", values_to = "Score") %>%
  group_by(GeneSet) %>%
  mutate(Z = scale(Score)[, 1]) %>%   # z-score each gene set
  group_by(SampleID) %>%
  summarise(immune_infiltration_David = mean(Z, na.rm = TRUE)) -> immune_infiltration_David_scores

db_ssGSEA_David_correct %>%
  as.data.frame() %>%
  select(`CD8 T cells`, `T cells`, `T helper cells`, `Tcm cells`, 
         `Tem cells`, `Th1 cells`, `Th17 cells`, `Th2 cells`, `Treg cells`) %>%
  rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "GeneSet", values_to = "Score") %>%
  group_by(GeneSet) %>%
  mutate(Z = scale(Score)[, 1]) %>%   # z-score each gene set
  group_by(SampleID) %>%
  summarise(tcell_infiltration_David = mean(Z, na.rm = TRUE)) -> tcell_infiltration_David_scores

db_ssGSEA_David_correct %>%
  rownames_to_column(var = "SampleID") %>%
  full_join(immune_infiltration_David_scores) %>%
  full_join(tcell_infiltration_David_scores) -> db_ssGSEA_David_correct

save(db_ssGSEA_David_correct, 
     file='data/processed/db_ssGSEA_David_correct.rda')

gsva_params <- GSVA::gsvaParam(exprData= log_cpm,
                               geneSets= geneset_list, 
                                   minSize = 1)

gsva_score_results <- gsva(param = gsva_params)

gsva_score_results %>% 
  as.data.frame() %>% t() -> gsva_score_results
  
cbind(meta_data, gsva_score_results[rownames(meta_data),]) -> db_GSVA_David_correct

db_GSVA_David_correct %>%
  as.data.frame() %>%
  select(aDC, `B cells`, `Cytotoxic cells`, DC, Eosinophils, iDC, Macrophages, `Mast cells`,
         Neutrophils, `NK CD56bright cells`, `NK CD56dim cells`, `NK cells`, pDC, `CD8 T cells`,
         `T cells`, `T helper cells`, `Tcm cells`, `Tem cells`, `Th1 cells`, `Th17 cells`,
         `Th2 cells`, `Treg cells`) %>%
  rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "GeneSet", values_to = "Score") %>%
  group_by(GeneSet) %>%
  mutate(Z = scale(Score)[, 1]) %>%   # z-score each gene set
  group_by(SampleID) %>%
  summarise(immune_infiltration_David = mean(Z, na.rm = TRUE)) -> immune_infiltration_David_scores

db_GSVA_David_correct %>%
  as.data.frame() %>%
  select(`CD8 T cells`, `T cells`, `T helper cells`, `Tcm cells`, 
         `Tem cells`, `Th1 cells`, `Th17 cells`, `Th2 cells`, `Treg cells`) %>%
  rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "GeneSet", values_to = "Score") %>%
  group_by(GeneSet) %>%
  mutate(Z = scale(Score)[, 1]) %>%   # z-score each gene set
  group_by(SampleID) %>%
  summarise(tcell_infiltration_David = mean(Z, na.rm = TRUE)) -> tcell_infiltration_David_scores

db_GSVA_David_correct %>%
  rownames_to_column(var = "SampleID") %>%
  full_join(immune_infiltration_David_scores) %>%
  full_join(tcell_infiltration_David_scores) -> db_GSVA_David_correct

save(db_GSVA_David_correct, 
     file='data/processed/db_GSVA_David_correct.rda')


```




### Sanity check

The numbers in the tables below should be consistent across all reports. 

If there are differences, this will indicate that 'data/processed/DGE_final_samples.rda' is not up to date.

```{r eval=TRUE}

load('data/processed/DGE_final_samples.rda')

CreateTableOne(vars=c('age', 'sex', 'prog_type', 
                      'csd', 'solar_elastosis_score', 'age_centered', 'age_centered_impute'),
               data=dge_final$samples %>%
                 filter(!duplicated(patient_id)),
                addOverall = TRUE)

CreateTableOne(vars=c('final_tissue_type_category'),
               data=dge_final$samples,
                addOverall = TRUE)

```

### Plot results, David signatures ssGSEA, log2 cpm CORRECT

The plots below were calculated by Lewis based on Davids signatures

```{r eval=TRUE,  fig.width=16, fig.height=18}

load(file='data/processed/db_ssGSEA_David_correct.rda')

db_ssGSEA_David_correct %>%
    filter(complete.cases(final_tissue_type_category)) %>%
  pivot_longer(cols=APM1:last_col(),
               names_to = 'cell_type',
               values_to = 'ssGSEA') %>%
  mutate(cell_type = str_remove(cell_type, 'ssGSEA_')) -> db_stats

db_stats %>%
  mutate(final_tissue_type_category=case_when(final_tissue_type_category=='Intermediate' ~ 'Inter',
                                     TRUE ~ final_tissue_type_category) %>% 
           factor(levels=c('Nevus', 'Inter', 'MIS',
                           'RGP', 'VGP'))) -> db_stats

L <- "Eosinophils"

lapply(unique(db_stats$cell_type), function(L){
  
  ##print(L)
  
  db_stats %>%
    filter(cell_type == L) -> temp
  
  lmer(ssGSEA ~ final_tissue_type_category + age_centered_impute + 
         sex + (1|patient_id),
       data=temp) -> mod1
  
  mod1 %>%
    emmeans(specs='final_tissue_type_category',
            contr='revpairwise', adjust='BH') %>% 
    .$contrasts %>% as.data.frame() %>%
    mutate(cell_type=L,
           group1=str_split(contrast, ' - ', simplify = T)[,1],
           group2=str_split(contrast, ' - ', simplify = T)[,2]) -> results
  
  results %>% 
    pivot_longer(cols=group1:group2,
                 values_to = 'final_tissue_type_category') %>%
    select(contrast, name, final_tissue_type_category) -> temp2
  
  temp %>% 
    group_by(final_tissue_type_category) %>%
    #filter(ssGSEA==boxplot.stats(ssGSEA)$stats[5]) %>%
    summarise(y.position= boxplot.stats(ssGSEA)$stats[5]) %>%
    full_join(y=temp2) %>%
    group_by(contrast) %>%
    filter(y.position==max(y.position)) %>%
    select(-final_tissue_type_category, -name) -> max_db
  
  max_db$y.position %>% range() %>% diff() -> DIFF
  
  results %>%
    full_join(max_db) %>%
    mutate(DIFF=DIFF) -> results
  
  
  # results %>%
  #   full_join(max_db) -> results
  
  # results %>%
  #   mutate(y.position=case_when(contrast %in% c("Inter - Nevus", "MIS - Inter", "RGP - MIS", "VGP - RGP") ~ max_db$y.position,
  #                               contrast == "VGP - Inter" ~ max_db$y.position * 1.2,
  #                               contrast %in% c("RGP - Inter") ~ max_db$y.position * 1.4,
  #                               contrast %in% c("MIS - Nevus", "VGP - MIS") ~ max_db$y.position * 1.6,
  #                               contrast %in% c("RGP - Inter") ~ max_db$y.position * 1.8,
  #                               contrast == "VGP - Nevus" ~ max_db$y.position * 2,
  #                               TRUE ~ max_db$y.position * 2.2)) -> results
    
return(results)
  
  
}) %>% 
  bind_rows() -> results_db

results_db %>%
  #adjust_pvalue(method = 'fdr') %>%
  add_significance(cutpoints = c(0, 0.001, 0.01, 0.05, 1),
                   symbols = c("***", "**", "*", "ns")) -> results_db


results_db %>% 
  ungroup() %>%
  filter(p.value.signif != 'ns') %>% 
  arrange(cell_type, y.position) %>%
  group_by(cell_type, y.position) %>%
  mutate(group_numbered = row_number(),
         ymod=(group_numbered-1) * DIFF,
         y.position=y.position+ymod) %>%
  ungroup() -> results_db_filter


#save(db_ssGSEA, results_db_ssGSEA,
#     file='immune_profiling_results/ssGSEA_Analysis/data_results.rda')


db_stats %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = ssGSEA,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('ssGSEA Davids signatures, Lewis'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=5)+
  theme_bw()+
  theme(legend.position = 'bottom')


results_db_ssgsea <- results_db

db_stats_ssgsea <- db_stats

save(results_db_ssgsea, db_stats_ssgsea,
     file='ssgsea_gsva_on_davids_signatures/results/results_db_ssgsea.rda')


```


### Plot results, David signatures GSVA, log2 cpm CORRECT

```{r eval=TRUE,  fig.width=16, fig.height=18}

load(file='data/processed/db_GSVA_David_correct.rda')

require(lme4)
require(emmeans)
require(rstatix)
require(ggpubr)

db_GSVA_David_correct %>%
    filter(complete.cases(final_tissue_type_category)) %>%
  pivot_longer(cols=APM1:last_col(),
               names_to = 'cell_type',
               values_to = 'GSVA') %>%
  mutate(cell_type = str_remove(cell_type, 'GSVA_')) -> db_stats

db_stats %>%
  mutate(final_tissue_type_category=case_when(final_tissue_type_category=='Intermediate' ~ 'Inter',
                                     TRUE ~ final_tissue_type_category) %>% 
           factor(levels=c('Nevus', 'Inter', 'MIS',
                           'RGP', 'VGP'))) -> db_stats


lapply(unique(db_stats$cell_type), function(L){
  
  ##print(L)
  
  db_stats %>%
    filter(cell_type == L) -> temp
  
  lmer(GSVA ~ final_tissue_type_category + age_centered_impute + 
         sex + (1|patient_id),
       data=temp) -> mod1
  
  mod1 %>%
    emmeans(specs='final_tissue_type_category',
            contr='revpairwise', adjust='BH') %>% 
    .$contrasts %>% as.data.frame() %>%
    mutate(cell_type=L,
           group1=str_split(contrast, ' - ', simplify = T)[,1],
           group2=str_split(contrast, ' - ', simplify = T)[,2]) -> results
  
  results %>% 
    pivot_longer(cols=group1:group2,
                 values_to = 'final_tissue_type_category') %>%
    select(contrast, name, final_tissue_type_category) -> temp2
  
  temp %>% 
    group_by(final_tissue_type_category) %>%
    #filter(ssGSEA==boxplot.stats(ssGSEA)$stats[5]) %>%
    summarise(y.position= boxplot.stats(GSVA)$stats[5]) %>%
    full_join(y=temp2) %>%
    group_by(contrast) %>%
    filter(y.position==max(y.position)) %>%
    select(-final_tissue_type_category, -name) -> max_db
  
  max_db$y.position %>% range() %>% diff() -> DIFF
  
  results %>%
    full_join(max_db) %>%
    mutate(DIFF=DIFF) -> results
    
return(results)
  
  
}) %>% 
  bind_rows() -> results_db

results_db %>%
  #adjust_pvalue(method = 'fdr') %>%
  add_significance(cutpoints = c(0, 0.001, 0.01, 0.05, 1),
                   symbols = c("***", "**", "*", "ns")) -> results_db

results_db %>% 
  ungroup() %>%
  filter(p.value.signif != 'ns') %>% 
  arrange(cell_type, y.position) %>%
  group_by(cell_type, y.position) %>%
  #filter(cell_type=='Eosinophils') %>%
  mutate(group_numbered = row_number(),
         ymod=(group_numbered-1) * DIFF,
         y.position=y.position+ymod) %>%
  ungroup() -> results_db_filter


db_stats %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = GSVA,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('GSVA Davids signatures, Lewis'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=5)+
  theme_bw()+
  theme(legend.position = 'bottom')

results_db_gsva <- results_db
db_stats_gsva <- db_stats

save(results_db_gsva, db_stats_gsva,
     file='ssgsea_gsva_on_davids_signatures/results/results_db_gsva.rda')

```


### Why are some gene-sets inconsistent between ssGSEA and GSVA?

Let's take a look at Th17 cells signature.

Notice there are more differences in the ssGSEA analysis.

ssGSEA: Is rank based, thus, scores can be inflated by one or two very high expression genes.

GSVA: Is distribution based, and is less impacted by individual genes.

Perhaps 1 or 2 extreme genes in the Th17 signature and leading to the increased differences in ssGSEA scores.

The visualizations below can be modified using *gs_of_interest*

```{r eval=TRUE,  fig.width=6.5, fig.height=4}

## put name of gene-set of interest here

gs_of_interest <- 'Th17 cells'

load(file='ssgsea_gsva_on_davids_signatures/results/results_db_gsva.rda')
load(file='ssgsea_gsva_on_davids_signatures/results/results_db_ssgsea.rda')

results_db_gsva %>% 
  ungroup() %>%
  filter(p.value.signif != 'ns',
         cell_type == gs_of_interest) %>% 
  arrange(cell_type, y.position) %>%
  group_by(cell_type, y.position) %>%
  #filter(cell_type=='Eosinophils') %>%
  mutate(group_numbered = row_number(),
         ymod=(group_numbered-1) * DIFF,
         y.position=y.position+ymod) %>%
  ungroup() -> results_db_filter


db_stats_gsva %>%
    filter(cell_type == gs_of_interest) %>% 
  ggplot(aes(x = final_tissue_type_category, 
             y = GSVA,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('GSVA, ', gs_of_interest), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=5)+
  theme_bw()+
  theme(legend.position = 'bottom')


results_db_ssgsea %>% 
  ungroup() %>%
  filter(p.value.signif != 'ns',
         cell_type == gs_of_interest) %>% 
  arrange(cell_type, y.position) %>%
  group_by(cell_type, y.position) %>%
  #filter(cell_type=='Eosinophils') %>%
  mutate(group_numbered = row_number(),
         ymod=(group_numbered-1) * DIFF,
         y.position=y.position+ymod) %>%
  ungroup() -> results_db_filter


db_stats_ssgsea %>%
    filter(cell_type == gs_of_interest) %>% 
  ggplot(aes(x = final_tissue_type_category, 
             y = ssGSEA,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('ssGSEA, ', gs_of_interest), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'p.value.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free', ncol=5)+
  theme_bw()+
  theme(legend.position = 'bottom')




```

#### Heatmaps visualizing Th17 genes

Ordered by GSVA score.

Scaled by column.

Notice, only three genes in the set

```{r eval=T, fig.width=9, fig.height=3}

require(pheatmap)
require(RColorBrewer)

load(file='data/processed/db_GSVA_David_correct.rda')

load('data/processed/DGE_final_samples.rda')

dge_final <- calcNormFactors(dge_final)

log_cpm <- cpm(dge_final, log = TRUE, prior.count = 1)

dge_final$genes %>%
  filter(complete.cases(Symbol)) -> annots_tab

name_vec <- dge_final$genes$GeneID 
names(name_vec) <- dge_final$genes$Symbol

read_delim('data/raw/gene_signatures_with_APMs_IFNG.Symbol.txt') %>%
  mutate(SymByID=name_vec[SymByEntrez]) %>%
  group_by(`Cell.Type`) %>%
  summarise(items = list(as.character(SymByID)), .groups = "drop") %>%
  deframe() -> geneset_list

geneset_list[[gs_of_interest]] -> gs_genes

dge_final$samples -> pheno

pheno$gsva_scores <- db_GSVA_David_correct[[gs_of_interest]]

pheno %>% 
  arrange(gsva_scores) -> pheno

BREAKS <- seq(-2, 2, by=0.1)

name_vec_plot <- names(name_vec)
names(name_vec_plot) <- name_vec

pheatmap(log_cpm[gs_genes, rownames(pheno)],
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = F,
         labels_row = name_vec_plot[gs_genes],
         annotation_col=pheno %>% select(final_tissue_type_category, gsva_scores),
         cluster_cols = F,
         main=paste0(gs_of_interest, ', samples ordered by GSVA score'),
         #gaps_col = which(!duplicated(pheno$final_tissue_type_category))[-1]-1,
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple')),
         scale = 'row')

```

Ordered by ssGSEA score.


```{r eval=T, fig.width=9, fig.height=3}

require(pheatmap)
require(RColorBrewer)

load(file='data/processed/db_ssGSEA_David_correct.rda')

load('data/processed/DGE_final_samples.rda')

dge_final <- calcNormFactors(dge_final)

log_cpm <- cpm(dge_final, log = TRUE, prior.count = 1)

dge_final$genes %>%
  filter(complete.cases(Symbol)) -> annots_tab

name_vec <- dge_final$genes$GeneID 
names(name_vec) <- dge_final$genes$Symbol

read_delim('data/raw/gene_signatures_with_APMs_IFNG.Symbol.txt') %>%
  mutate(SymByID=name_vec[SymByEntrez]) %>%
  group_by(`Cell.Type`) %>%
  summarise(items = list(as.character(SymByID)), .groups = "drop") %>%
  deframe() -> geneset_list

geneset_list[[gs_of_interest]] -> gs_genes

dge_final$samples -> pheno

pheno$ssgsea_scores <- db_ssGSEA_David_correct[[gs_of_interest]]

pheno %>% 
  arrange(ssgsea_scores) -> pheno

BREAKS <- seq(-2, 2, by=0.1)

name_vec_plot <- names(name_vec)
names(name_vec_plot) <- name_vec

pheatmap(log_cpm[gs_genes, rownames(pheno)],
         breaks = BREAKS,
         color = colorRampPalette(rev(brewer.pal(n = 8, name ="RdBu")))(length(BREAKS)),
         show_rownames = T, 
         show_colnames = F,
         labels_row = name_vec_plot[gs_genes],
         annotation_col=pheno %>% select(final_tissue_type_category, ssgsea_scores),
         cluster_cols = F,
         main=paste0(gs_of_interest, ', samples ordered by ssGSEA score'),
         #gaps_col = which(!duplicated(pheno$final_tissue_type_category))[-1]-1,
         annotation_colors = list(final_tissue_type_category=c(Nevus='green',
                                                               Intermediate='yellow',
                                                               MIS='orange',
                                                               RGP='red',
                                                               VGP='purple')),
         scale = 'row')

```

### STOP, CODE BELOW IS NOT USED

```{r}

# Run GSVA with ssGSEA method
david_ssgsea_scores <- gsva(param = ssgsea_params)

david_ssgsea_scores %>% 
  as.data.frame() -> david_ssgsea_scores

rownames(david_ssgsea_scores) <- paste0('ssGSEA_', rownames(david_ssgsea_scores))

david_ssgsea_scores %>%
  t() %>% 
  as.data.frame() %>%
  rownames_to_column('sample') -> david_rlog_ssgsea_scores

david_rlog_ssgsea_scores$ssGSEA_NMD_Reactome








kc_ssgsea_scores %>% str()

kc_ssgsea_scores %>% 
  as.data.frame() -> kc_ssgsea_scores

rownames(kc_ssgsea_scores) <- paste0('ssGSEA_', rownames(kc_ssgsea_scores))
  
gsva_params <- GSVA::gsvaParam(exprData= vobj_no_filter$E,
                               geneSets= custom_genes)

kc_gsva_scores <- gsva(param = gsva_params)

kc_gsva_scores %>% 
  as.data.frame() -> kc_gsva_scores

rownames(kc_gsva_scores) <- paste0('GSVA_', rownames(kc_gsva_scores))

custom_enrichment <- bind_rows(kc_gsva_scores, 
                               kc_ssgsea_scores)

custom_enrichment %>%
  t() %>% as.data.frame() %>%
  rownames_to_column('sample') -> custom_enrichment

save(custom_enrichment,
     file='immune_profiling_results/custom_enrichment_scores/custom_enrichment.rda')

read_csv('data/May_2025_Analysis/UCSF_RNAseq_2025_May_SampleInfo_Lewis.csv') %>% 
  janitor::clean_names() %>%
  mutate(david_kuo_outlier=case_when(comment=='PCA outlier (David Kuo)' ~ 'dk_outlier',
                                     TRUE ~ 'OK')) %>%
  select(-comment) -> sample_data

sample_data %>%
  group_by(patient_id) %>%
  summarise(MIS_count=any(final_tissue_type_category == 'MIS')) %>%
  mutate(prog_type=case_when(MIS_count==TRUE ~ 'with_MIS',
                            TRUE ~ 'no_MIS')) %>%
  full_join(sample_data) -> sample_data


intersect(custom_enrichment$sample, sample_data$sample) %>% sort()

symmetric_diff <- function(a, b) {
  union(setdiff(a, b), setdiff(b, a))
}

symmetric_diff(custom_enrichment$sample, sample_data$sample) 

sample_data$final_tissue_type_category %>% table()

colnames(custom_enrichment)

cell_sample_data <- inner_join(x=sample_data,
                               y=custom_enrichment) %>%
  filter(final_tissue_type_category != 'Regressed-Area') %>%
  mutate(final_tissue_type_category= factor(final_tissue_type_category,
                                            levels=c('Nevus', 'Intermediate', 'MIS',
                                                     'RGP', 'VGP'))) %>%
  rename(final_tissue_type_category=final_tissue_type_category)

read_csv('data/patient_information.csv') %>% 
  filter(!duplicated(patient_id)) -> patient_data

patient_data$age_centered <- scale(patient_data$age, center = TRUE, scale = FALSE)[,1]
patient_data$age_centered_impute <- patient_data$age_centered
patient_data$sex_change_impute <- patient_data$sex_change
patient_data$age_centered_impute[is.na(patient_data$age_centered_impute)] <- 0
patient_data$sex_change_impute[is.na(patient_data$sex_change_impute)] <- 'Male'

cell_sample_data %>% as.data.frame()

cell_sample_data %>%
  inner_join(patient_data) -> cell_sample_data

save(cell_sample_data, 
     file='data/immune_profiles/custom_genesets_data.rda')  


```


```{r}

cell_sample_data %>% as.data.frame()

cell_sample_data %>%
  pivot_longer(cols=c(contains('ssGSEA_'), contains('GSVA_')),
               names_to = 'cell_type',
               values_to = 'score') -> db_stats

db_stats %>% as.data.frame()

L = 't_cd4_mem_rest'

db_stats %>%
  mutate(final_tissue_type_category=case_when(final_tissue_type_category=='Intermediate' ~ 'Inter',
                                     TRUE ~ final_tissue_type_category) %>% 
           factor(levels=c('Nevus', 'Inter', 'MIS',
                           'RGP', 'VGP'))) -> db_stats

require(lme4)
require(emmeans)
require(rstatix)
require(ggpubr)

L <- 'ssGSEA_immune_infiltration'

lapply(unique(db_stats$cell_type), function(L){
  
  print(L)
  
  db_stats %>%
    filter(cell_type == L) -> temp
  
  temp$score %>% hist()
  
  lmer(score ~ final_tissue_type_category + age_centered_impute + 
         sex_change_impute + (1|patient_id),
       data=temp) -> mod1
  
  mod1 %>%
    emmeans(specs='final_tissue_type_category',
            contr='revpairwise', adjust='none') %>% 
    .$contrasts %>% as.data.frame() %>%
    mutate(cell_type=L,
           group1=str_split(contrast, ' - ', simplify = T)[,1],
           group2=str_split(contrast, ' - ', simplify = T)[,2]) -> results
  
  temp %>% 
    group_by(final_tissue_type_category) %>%
    summarise(y.position=max(score)) -> max_db
  
  results %>%
    select(contrast, group1, group2) %>%
    pivot_longer(cols=group1:group2,
                 values_to = 'final_tissue_type_category') %>%
    full_join(y=max_db) %>%
    group_by(contrast) %>%
    filter(y.position==max(y.position)) %>%
    select(contrast, y.position)  %>%
    full_join(y=results) -> results
    
return(results)
  
  
}) %>% 
  bind_rows() -> results_db

results_db$cell_type %>% table()


results_db %>%
  filter(cell_type=='ssGSEA_immune_infiltration') %>% 
  arrange(estimate) %>%
  as.data.frame()

results_db %>%
  adjust_pvalue(method = 'fdr') %>%
  add_significance(cutpoints = c(0, 0.001, 0.01, 0.05, 1),
                   symbols = c("***", "**", "*", "ns")) -> results_db

results_db %>% 
  filter(p.value.adj.signif != 'ns') %>% 
  group_by(cell_type, y.position) %>%
  mutate(
    dup_id = row_number(), 
    y.position.staggered = y.position + (y.position/2) * (dup_id - 1)
  ) %>%
  ungroup() -> results_db_filter


results_db_filter %>%
  filter(cell_type=='ssGSEA_immune_infiltration') %>% as.data.frame()


db_stats %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = score,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  labs(title = paste0('custom gene sets'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter, 
                     label = 'p.value.adj.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position.staggered',
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free')+
  theme_bw()

ggsave(file=paste0('immune_profiling_results/box_plots_ssGSEA_noline/all_noline.tiff'),
       width=17, height=12)

colnames(db_stats)

db_stats$cell_type %>% table()

db_stats %>%
  filter(cell_type %in% c('GSVA_NMD_Reactome', 'GSVA_immune_infiltration')) %>%
  select(sample, score, final_tissue_type_category, cell_type) %>%
  mutate(final_tissue_type_category=factor(final_tissue_type_category,
                                  levels=c('Nevus', 'Inter', 'MIS', 'RGP', 'VGP'))) %>%
  pivot_wider(id_cols = c(sample, final_tissue_type_category),
              names_from = cell_type,
              values_from = score) %>%
  ggplot(aes(x=GSVA_NMD_Reactome,
             y=GSVA_immune_infiltration,
             color=final_tissue_type_category))+
  #geom_abline()+
  geom_point()+
  geom_smooth(inherit.aes = F, color='black',
              aes(x=GSVA_NMD_Reactome,
                  y=GSVA_immune_infiltration), 
              method = 'lm', linetype='dashed') +
  facet_wrap(~final_tissue_type_category, scales='free')+
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  labs(title='Correlation NMD Immune Infiltration')+
  #stat_cor(aes(x=GSVA_NMD_Reactome,
  #             y=GSVA_immune_infiltration), 
  #         inherit.aes = F, method = "spearman", 
  #         label.x = -0.5, size = 3) + 
  theme_classic()

colnames(db_stats)

db_stats %>%
  filter(cell_type %in% c('GSVA_NMD_Reactome', 'GSVA_immune_infiltration')) %>%
  select(sample, score, final_tissue_type_category, cell_type, age_centered_impute, sex_change_impute, patient_id) %>%
  mutate(final_tissue_type_category=factor(final_tissue_type_category,
                                  levels=c('Nevus', 'Inter', 'MIS', 'RGP', 'VGP'))) %>%
  pivot_wider(id_cols = c(sample, final_tissue_type_category, age_centered_impute, sex_change_impute, patient_id),
              names_from = cell_type,
              values_from = score) -> db_NMD

require(emmeans)

  
  db_NMD$GSVA_immune_infiltration %>% hist()
  
  lmer(GSVA_immune_infiltration ~ GSVA_NMD_Reactome * final_tissue_type_category + age_centered_impute + 
         sex_change_impute + (1|patient_id),
       data=db_NMD) -> mod1

  
  summary(mod1)
  
  mod1 %>%
    emtrends(specs = 'final_tissue_type_category', var='GSVA_NMD_Reactome') %>% 
    test() %>%
    as.data.frame() %>%
    add_significance()
  
    lmer(GSVA_immune_infiltration ~ GSVA_NMD_Reactome + age_centered_impute + 
         sex_change_impute + (1|patient_id),
       data=db_NMD) -> mod2

  
  summary(mod2)
  
  anova(mod1, mod2)
  
  mod2 %>%
    emtrends(specs = ~1, var='GSVA_NMD_Reactome') %>% 
    test() %>%
    as.data.frame() %>%
    add_significance() 
  
  
  library(lme4)
library(emmeans)
library(ggplot2)
library(dplyr)

# Your model
mod1 <- lmer(GSVA_immune_infiltration ~ GSVA_NMD_Reactome * final_tissue_type_category + 
               age_centered_impute + sex_change_impute + (1|patient_id),
             data = db_NMD, REML = TRUE)

# Step 1: Create a grid for prediction
grid <- expand.grid(
  GSVA_NMD_Reactome = seq(min(db_NMD$GSVA_NMD_Reactome, na.rm=TRUE),
                          max(db_NMD$GSVA_NMD_Reactome, na.rm=TRUE),
                          length.out = 100),
  final_tissue_type_category = unique(db_NMD$final_tissue_type_category),
  age_centered_impute = mean(db_NMD$age_centered_impute, na.rm=TRUE),
  sex_change_impute = "Female")

# Step 2: Get predicted values (ignore random effects)
grid$predicted <- predict(mod1, newdata = grid, re.form = NA)

# Step 3: Plot
ggplot(db_NMD, aes(x = GSVA_NMD_Reactome, y = GSVA_immune_infiltration, color = final_tissue_type_category)) +
  geom_point(alpha = 0.5) +
  geom_line(data = grid, aes(x = GSVA_NMD_Reactome, y = predicted, color = final_tissue_type_category), size = 1.2) +
  theme_bw() +
  facet_wrap(~final_tissue_type_category, scales='free')+
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  labs(title = "Model-based trends from lmer",
       y = "Immune Infiltration",
       x = "NMD Pathway Score")
  
  

  







db_stats %>%
  filter(cell_type=='reactome_nmd') %>%
  ggplot(aes(x = final_tissue_type_category, 
             y = ssGSEA,
             color = final_tissue_type_category)) +
  geom_boxplot(outliers = F)+
  #geom_line(aes(group = patient_id), color = 'black', position = pos_jitter) +
  #geom_point(size = 0.5, position = pos_jitter) +
  geom_jitter(width=0.25, size=0.5)+
  #labs(title = paste0('sGSEA'), x=NULL) +
  scale_color_manual(values=c(Nevus='green',
                              Inter='yellow',
                              MIS='orange',
                              RGP='red',
                              VGP='purple'))+
  stat_pvalue_manual(data=results_db_filter %>%
                       filter(cell_type=='reactome_nmd') , 
                     label = 'p.value.adj.signif',
                     hide.ns = TRUE,
                     y.position = 'y.position',
                     step.increase = 0.1,
                     tip.length = 0)+
  scale_y_continuous(expand = expansion(mult=0.1))+
  facet_wrap(~cell_type, scales='free')+
  theme_bw()


db_ssGSEA <- db_plot
results_db_ssGSEA <- results_db

save(db_ssGSEA, results_db_ssGSEA,
     file='immune_profiling_results/ssGSEA_Analysis/data_results.rda')



```





